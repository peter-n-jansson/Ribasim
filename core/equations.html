<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Ribasim - Equations</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../core/allocation.html" rel="next">
<link href="../core/validation.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../assets/styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="https://user-images.githubusercontent.com/4471859/224825908-bee7e044-bc6b-4561-8b08-5d330cce3ed5.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Ribasim</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="../core/index.html" aria-current="page"> 
<span class="menu-text">Julia core</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../python/index.html"> 
<span class="menu-text">Python tooling</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../qgis/index.html"> 
<span class="menu-text">QGIS plugin</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../contribute/index.html"> 
<span class="menu-text">Contributing</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/Deltares/Ribasim"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../core/equations.html">Equations</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../core/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Julia core</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../core/modelconcept.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Model concept</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../core/usage.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Usage</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../core/validation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Validation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../core/equations.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Equations</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../core/allocation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Allocation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../core/numerics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Numerical considerations</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../build/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">API Reference</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#formal-model-description" id="toc-formal-model-description" class="nav-link active" data-scroll-target="#formal-model-description"><span class="header-section-number">1</span> Formal model description</a>
  <ul class="collapse">
  <li><a href="#the-jacobian" id="toc-the-jacobian" class="nav-link" data-scroll-target="#the-jacobian"><span class="header-section-number">1.1</span> The Jacobian</a></li>
  </ul></li>
  <li><a href="#natural-water-balance-terms" id="toc-natural-water-balance-terms" class="nav-link" data-scroll-target="#natural-water-balance-terms"><span class="header-section-number">2</span> Natural water balance terms</a>
  <ul class="collapse">
  <li><a href="#sec-reduction_factor" id="toc-sec-reduction_factor" class="nav-link" data-scroll-target="#sec-reduction_factor"><span class="header-section-number">2.1</span> The reduction factor</a></li>
  <li><a href="#precipitation" id="toc-precipitation" class="nav-link" data-scroll-target="#precipitation"><span class="header-section-number">2.2</span> Precipitation</a></li>
  <li><a href="#evaporation" id="toc-evaporation" class="nav-link" data-scroll-target="#evaporation"><span class="header-section-number">2.3</span> Evaporation</a></li>
  <li><a href="#infiltration-and-drainage" id="toc-infiltration-and-drainage" class="nav-link" data-scroll-target="#infiltration-and-drainage"><span class="header-section-number">2.4</span> Infiltration and Drainage</a></li>
  <li><a href="#upstream-and-downstream-flow" id="toc-upstream-and-downstream-flow" class="nav-link" data-scroll-target="#upstream-and-downstream-flow"><span class="header-section-number">2.5</span> Upstream and downstream flow</a>
  <ul class="collapse">
  <li><a href="#sec-pump" id="toc-sec-pump" class="nav-link" data-scroll-target="#sec-pump"><span class="header-section-number">2.5.1</span> Pump</a></li>
  <li><a href="#sec-outlet" id="toc-sec-outlet" class="nav-link" data-scroll-target="#sec-outlet"><span class="header-section-number">2.5.2</span> Outlet</a></li>
  <li><a href="#tabulatedratingcurve" id="toc-tabulatedratingcurve" class="nav-link" data-scroll-target="#tabulatedratingcurve"><span class="header-section-number">2.5.3</span> TabulatedRatingCurve</a></li>
  <li><a href="#linearresistance" id="toc-linearresistance" class="nav-link" data-scroll-target="#linearresistance"><span class="header-section-number">2.5.4</span> LinearResistance</a></li>
  <li><a href="#terminal" id="toc-terminal" class="nav-link" data-scroll-target="#terminal"><span class="header-section-number">2.5.5</span> Terminal</a></li>
  <li><a href="#levelboundary" id="toc-levelboundary" class="nav-link" data-scroll-target="#levelboundary"><span class="header-section-number">2.5.6</span> LevelBoundary</a></li>
  <li><a href="#flowboundary" id="toc-flowboundary" class="nav-link" data-scroll-target="#flowboundary"><span class="header-section-number">2.5.7</span> FlowBoundary</a></li>
  <li><a href="#manning-connection" id="toc-manning-connection" class="nav-link" data-scroll-target="#manning-connection"><span class="header-section-number">2.5.8</span> Manning connection</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#userdemand-allocation" id="toc-userdemand-allocation" class="nav-link" data-scroll-target="#userdemand-allocation"><span class="header-section-number">3</span> UserDemand allocation</a></li>
  <li><a href="#sec-PID" id="toc-sec-PID" class="nav-link" data-scroll-target="#sec-PID"><span class="header-section-number">4</span> PID controller</a>
  <ul class="collapse">
  <li><a href="#the-derivative-term" id="toc-the-derivative-term" class="nav-link" data-scroll-target="#the-derivative-term"><span class="header-section-number">4.1</span> The derivative term</a></li>
  <li><a href="#the-sign-of-the-parameters" id="toc-the-sign-of-the-parameters" class="nav-link" data-scroll-target="#the-sign-of-the-parameters"><span class="header-section-number">4.2</span> The sign of the parameters</a></li>
  </ul></li>
  <li><a href="#numerical-solution" id="toc-numerical-solution" class="nav-link" data-scroll-target="#numerical-solution"><span class="header-section-number">5</span> Numerical solution</a></li>
  <li><a href="#performance" id="toc-performance" class="nav-link" data-scroll-target="#performance"><span class="header-section-number">6</span> Performance</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Equations</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Ribasim currently simulates the following “natural” water balance terms:</p>
<ol type="1">
<li>Precipitation</li>
<li>Evaporation</li>
<li>Infiltration</li>
<li>Drainage</li>
<li>Urban runoff</li>
<li>Upstream and downstream flow</li>
</ol>
<p>Additionally, Ribasim simulates the following “allocated” water balance terms:</p>
<ol type="1">
<li>UserDemand</li>
<li>Flushing</li>
</ol>
<p>Depending on the type of boundary conditions, Ribasim requires relation between storage volume and wetted area <span class="math inline">\(A\)</span>, and between the storage volume and the water level <span class="math inline">\(h\)</span>. These are (currently) represented by piecewise linear relationships.</p>
<section id="formal-model-description" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Formal model description</h1>
<p>In this section we give a formal description of the problem that is solved by Ribasim. The problem is of the form</p>
<p><span id="eq-system"><span class="math display">\[
\frac{\text{d}\mathbf{u}}{\text{d}t} = f(\mathbf{u},p(t),t),\quad t \in [t_0,t_\text{end}],
\tag{1}\]</span></span></p>
<p>i.e.&nbsp;a system of coupled first order ordinary differential equations, with initial condition <span class="math inline">\(\mathbf{u}(t_0)= \mathbf{u}_0\)</span> and time dependent input data denoted by <span class="math inline">\(p(t)\)</span>.</p>
<p>The model is given by a directed graph, consisting of a set of nodes (or vertices) <span class="math inline">\(V\)</span> and edges <span class="math inline">\(E\)</span>. Let <span class="math inline">\(V\)</span> be the set of node IDs and let <span class="math inline">\(E\)</span> be the set of ordered tuples <span class="math inline">\((i,j)\)</span> meaning that node <span class="math inline">\(i\)</span> is connected to node <span class="math inline">\(j\)</span>.</p>
<p>We can split the set of nodes into two subsets <span class="math inline">\(V = B \cup N\)</span>, where <span class="math inline">\(B\)</span> is the set of basins and <span class="math inline">\(N\)</span> is the set of non-basins. The basins have an associated storage state and the non-basins dictate how water flows to or from basins.</p>
<p><span class="math inline">\(\mathbf{u}(t)\)</span> is given by all the states of the model, which are (currently) the storage of the basins and the integral terms of the PID controllers, the latter being explained in <a href="../core/equations.html#sec-PID">3 PID controller</a>.</p>
<p>Given a single basin with node ID <span class="math inline">\(i \in B\)</span>, the equation that dictates the change of its storage over time is given by</p>
<p><span class="math display">\[
\frac{\text{d}u_i}{\text{d}t} =
\sum_{(i',j') \in E | j' = i} Q_{i',j'} - \sum_{(i',j') \in E | i' = i} Q_{i',j'} + F_i(p,t).
\]</span></p>
<p>Here <span class="math inline">\(Q_{i,j}\)</span> is the flow along an edge, where the graph direction dictates positive flow. So the first term denotes flow towards the basin, the second one denotes flow away from the basin, and the third term denotes external forcing. <span class="math inline">\(F_i(p,t)\)</span> is given by input data, and <span class="math inline">\(Q_{i' ,j'}\)</span> is determined by the type of nodes that connect to that edge.</p>
<p>The various node and forcing types that the model can contain are explained in the section <a href="../core/equations.html#natural-water-balance-terms">Natural water balance terms</a>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>In general a model has more nodes than states, so in the Julia core there is a distinction between node indices and state indices. For simplicity these are treated as equal in the documentation when it comes to basins and their storage.</p>
</div>
</div>
<section id="the-jacobian" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="the-jacobian"><span class="header-section-number">1.1</span> The Jacobian</h2>
<p>The Jacobian is a <span class="math inline">\(n\times n\)</span> matrix where <span class="math inline">\(n\)</span> is the number of states in the simulation. The Jacobian is computed either using finite difference methods or automatic differentiation. For more details on the computation of the Jacobian and how it is used in the solvers see <a href="../core/numerics.html">numerical considerations</a>.</p>
<p>The entries of the Jacobian <span class="math inline">\(J\)</span> are given by <span class="math display">\[
J[i,j] = \frac{\partial f_j}{\partial u_i},
\]</span></p>
<p>hence <span class="math inline">\(J[i,j]\)</span> quantifies how <span class="math inline">\(f_j\)</span>, the derivative of state <span class="math inline">\(j\)</span> with respect to time, changes with a change in state <span class="math inline">\(i\)</span>. If a node creates dependendies between basin storages (or other states), then this yields contributions to the Jacobian. If <span class="math inline">\(j\)</span> corresponds to a storage state, then</p>
<p><span class="math display">\[
J[i,j] = \sum_{(i',j') \in E | j' = i} \frac{\partial Q_{i',j'}}{\partial u_i} - \sum_{(i',j') \in E | i' = i} \frac{\partial Q_{i',j'}}{\partial u_i},
\]</span></p>
<p>Most of these terms are always <span class="math inline">\(0\)</span>, because a flow over an edge only depends on a small number of states. Therefore the matrix <span class="math inline">\(J\)</span> is very sparse.</p>
<p>For many contributions to the Jacobian the derivative of the level <span class="math inline">\(l(u)\)</span> of a basin with respect to its storage <span class="math inline">\(u\)</span> is required. To get an expression for this, we first look at the storage as a function of the level:</p>
<p><span class="math display">\[
u(l) = \int_{l_0}^l A(\ell)d\ell.
\]</span></p>
<p>From this we obtain <span class="math inline">\(u'(l) = A(l)\)</span> and thus <span class="math display">\[
\frac{\text{d}l}{\text{d}u} = \frac{1}{A(u)}.
\]</span></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The presence of division by the basin area means that areas of size zero are not allowed.</p>
</div>
</div>
</section>
</section>
<section id="natural-water-balance-terms" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Natural water balance terms</h1>
<section id="sec-reduction_factor" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="sec-reduction_factor"><span class="header-section-number">2.1</span> The reduction factor</h2>
<p>At several points in the equations below a <em>reduction factor</em> is used. This is a term that makes certain transitions more smooth, for instance when a pump stops providing water when its source basin dries up. The reduction factor is given by</p>
<p><span class="math display">\[\begin{align}
    \phi(x; p) =
    \begin{cases}
    0 &amp;\text{if}\quad x &lt; 0 \\
        -2 \left(\frac{x}{p}\right)^3 + 3\left(\frac{x}{p}\right)^2 &amp;\text{if}\quad 0 \le x \le p \\
        1 &amp;\text{if}\quad x &gt; p
    \end{cases}
\end{align}\]</span></p>
<p>Here <span class="math inline">\(p &gt; 0\)</span> is the threshold value which determines the interval <span class="math inline">\([0,p]\)</span> of the smooth transition between <span class="math inline">\(0\)</span> and <span class="math inline">\(1\)</span>, see the plot below.</p>
<div id="5fa91fef" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> f(x, p <span class="op">=</span> <span class="dv">3</span>):</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    x_scaled <span class="op">=</span> x <span class="op">/</span> p</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    phi <span class="op">=</span> (<span class="op">-</span><span class="dv">2</span> <span class="op">*</span> x_scaled <span class="op">+</span> <span class="dv">3</span>) <span class="op">*</span> x_scaled<span class="op">**</span><span class="dv">2</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    phi <span class="op">=</span> np.where(x <span class="op">&lt;</span> <span class="dv">0</span>, <span class="dv">0</span>, phi)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    phi <span class="op">=</span> np.where(x <span class="op">&gt;</span> p, <span class="dv">1</span>, phi)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> phi</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>fontsize <span class="op">=</span> <span class="dv">15</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>x_min <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>x_max <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.linspace(x_min,x_max,N)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>phi <span class="op">=</span> f(x,p)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>fig,ax <span class="op">=</span> plt.subplots(dpi<span class="op">=</span><span class="dv">80</span>)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>ax.plot(x,phi)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>y_lim <span class="op">=</span> ax.get_ylim()</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>ax.set_xticks([<span class="dv">0</span>,p], [<span class="dv">0</span>,<span class="st">"$p$"</span>], fontsize<span class="op">=</span>fontsize)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>ax.set_yticks([<span class="dv">0</span>,<span class="dv">1</span>], [<span class="dv">0</span>,<span class="dv">1</span>], fontsize<span class="op">=</span>fontsize)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>ax.hlines([<span class="dv">0</span>,<span class="dv">1</span>],x_min,x_max, color <span class="op">=</span> <span class="st">"k"</span>, ls <span class="op">=</span> <span class="st">":"</span>, zorder<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>ax.vlines([<span class="dv">0</span>,p], <span class="op">*</span>y_lim, color <span class="op">=</span> <span class="st">"k"</span>, ls <span class="op">=</span> <span class="st">":"</span>)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(x_min,x_max)</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"$x$"</span>, fontsize<span class="op">=</span>fontsize)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"$\phi(x;p)$"</span>, fontsize<span class="op">=</span>fontsize)</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(y_lim)</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>&lt;&gt;:31: SyntaxWarning:

invalid escape sequence '\p'

&lt;&gt;:31: SyntaxWarning:

invalid escape sequence '\p'

/tmp/ipykernel_5154/665069857.py:31: SyntaxWarning:

invalid escape sequence '\p'
</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="equations_files/figure-html/cell-2-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="precipitation" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="precipitation"><span class="header-section-number">2.2</span> Precipitation</h2>
<p>The precipitation term is given by</p>
<p><span id="eq-precip"><span class="math display">\[
    Q_P = P \cdot A.
\tag{2}\]</span></span></p>
<p>Here <span class="math inline">\(P = P(t)\)</span> is the precipitation rate and <span class="math inline">\(A\)</span> is the maximum area given in the <code>Basin / profile</code> table. Precipitation in the Basin area is assumed to be directly added to the Basin storage. The modeler needs to ensure all precipitation enters the model, and there is no overlap in the maximum profile areas, else extra water is created. If a part of the catchment is not in any Basin profile, the modeler has to verify that water source is not forgotten. It can for instance be converted to a flow rate and added to a Basin as a FlowBoundary.</p>
</section>
<section id="evaporation" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="evaporation"><span class="header-section-number">2.3</span> Evaporation</h2>
<p>The evaporation term is given by</p>
<p><span id="eq-evap"><span class="math display">\[
    Q_E = E_\text{pot} \cdot A(u) \cdot \phi(d;0.1).
\tag{3}\]</span></span></p>
<p>Here <span class="math inline">\(E_\text{pot} = E_\text{pot}(t)\)</span> is the potential evaporation rate and <span class="math inline">\(A\)</span> is the wetted area. <span class="math inline">\(\phi\)</span> is the <a href="../core/equations.html#sec-reduction_factor">reduction factor</a> which depends on the depth <span class="math inline">\(d\)</span>. It provides a smooth gradient as <span class="math inline">\(u \rightarrow 0\)</span>.</p>
<p>A straightforward formulation <span class="math inline">\(Q_E = \mathrm{max}(E_\text{pot} A(u),
0)\)</span> is unsuitable, as <span class="math inline">\(\frac{\mathrm{d}Q_E}{\mathrm{d}u}(u=0)\)</span> is then not well-defined.</p>
<!--
A hyperbolic tangent is a commonly used activation function
[@enwiki:1106669904] to approximate on-off behavior while preserving a smooth
derivative.
-->
<p>A non-smooth derivative results in extremely small timesteps and long computation time: ModelingToolkit identifies the singular behavior and adjusts its timestepping. In a physical interpretation, evaporation is switched on or off per individual droplet of water. In general, the effect of the reduction term is negligible, or not even necessary. As a surface water dries, its wetted area decreases and so does the evaporative flux. However, for (simplified) cases with constant wetted surface (a rectangular profile), evaporation only stops at <span class="math inline">\(u =
0\)</span>.</p>
</section>
<section id="infiltration-and-drainage" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="infiltration-and-drainage"><span class="header-section-number">2.4</span> Infiltration and Drainage</h2>
<p>Infiltration is provided as a lump sum for the basin. If Ribasim is coupled with MODFLOW 6, the infiltration is computed as the sum of all <strong>positive</strong> flows of the MODFLOW 6 boundary conditions in the basin:</p>
<p><span id="eq-inf"><span class="math display">\[
    Q_\text{inf} = \sum_{i=1}^{n} \sum_{j=1}^{m} \max(Q_{\mathrm{mf6}_{i,j}}, 0.0)
\tag{4}\]</span></span></p>
<p>Where <span class="math inline">\(i\)</span> is the index of the boundary condition, <span class="math inline">\(j\)</span> the MODFLOW 6 cell index, <span class="math inline">\(n\)</span> the number of boundary conditions, and <span class="math inline">\(m\)</span> the number of MODFLOW 6 cells in the basin. <span class="math inline">\(Q_{\mathrm{mf6}_{i,j}}\)</span> is the flow computed by MODFLOW 6 for cell <span class="math inline">\(j\)</span> for boundary condition <span class="math inline">\(i\)</span>.</p>
<p>Drainage is a lump sump for the basin, and consists of the sum of the absolute value of all <strong>negative</strong> flows of the MODFLOW 6 boundary conditions in the basin.</p>
<p><span id="eq-drn"><span class="math display">\[
    Q_\text{drn} = \sum_{i=1}^{n} \sum_{j=1}^{m} \left| \min(Q_{\mathrm{mf6}_{i,j}}, 0.0) \right|
\tag{5}\]</span></span></p>
<p>The interaction with MODFLOW 6 boundary conditions is explained in greater detail in the <a href="https://deltares.github.io/iMOD-Documentation/coupler.html">the iMOD Coupler docs</a>.</p>
</section>
<section id="upstream-and-downstream-flow" class="level2" data-number="2.5">
<h2 data-number="2.5" class="anchored" data-anchor-id="upstream-and-downstream-flow"><span class="header-section-number">2.5</span> Upstream and downstream flow</h2>
<p>Ribasim’s basins can be connected to each other, and each basin expects an explicit connection. These connections are currently available for inter-basin flows:</p>
<!-- Is the pump a natural water balance term? -->
<ol type="1">
<li><code>Pump</code></li>
<li><code>TabulatedRatingCurve</code></li>
<li><code>LinearResistance</code></li>
<li><code>ManningResistance</code></li>
</ol>
<p>The flow direction of the basin is not pre-determined: flow directions may freely reverse, provided the connection allows it. Currently, a <code>LinearResistance</code> allows bidirectional flow, but the</p>
<p>Additionally, three additional “connections” area available for the “outmost” basins (external nodes) in a network.</p>
<ol type="1">
<li><code>Terminal</code></li>
<li><code>LevelBoundary</code></li>
<li><code>FlowBoundary</code></li>
</ol>
<section id="sec-pump" class="level3" data-number="2.5.1">
<h3 data-number="2.5.1" class="anchored" data-anchor-id="sec-pump"><span class="header-section-number">2.5.1</span> Pump</h3>
<p>The behaviour of pumps is very straight forward if these nodes are not PID controlled. Their flow is given by a fixed flow rate <span class="math inline">\(q\)</span>, multiplied by a reduction factor: <span class="math display">\[
Q_\text{pump} = \phi(u; 10.0)q
\]</span></p>
<p>Here <span class="math inline">\(u\)</span> is the storage of the upstream basin. The <a href="../core/equations.html#sec-reduction_factor">reduction factor</a> <span class="math inline">\(\phi\)</span> makes sure that the flow of the pump goes smootly to <span class="math inline">\(0\)</span> as the upstream basin dries out.</p>
</section>
<section id="sec-outlet" class="level3" data-number="2.5.2">
<h3 data-number="2.5.2" class="anchored" data-anchor-id="sec-outlet"><span class="header-section-number">2.5.2</span> Outlet</h3>
<p>The outlet is very similar to the pump, but it has a few extra <a href="../core/equations.html#sec-reduction_factor">reduction factors</a> for physical constraints: <span class="math display">\[
Q_\text{outlet} = \phi(u_a; 10.0)\phi(\Delta h; 0.1) \phi(h_a-h_\text{min};0.1)q.
\]</span> The subscript <span class="math inline">\(a\)</span> denotes the upstream node and <span class="math inline">\(b\)</span> the downstream node. The first reduction factor is equivalent to the one for the pump. The second one makes sure that the outlet flow goes to zero as the head difference <span class="math inline">\(\Delta h = h_a - h_b\)</span> goes to zero. The last one makes sure that the outlet only produces flow when the upstream level is above the minimum chrest level <span class="math inline">\(h_\text{min}\)</span>.</p>
<p>Not all node types upstream or downstream of the outlet have a defined level. If this is the case, and therefore the reduction factor cannot be computed, it is defined to be <span class="math inline">\(1.0\)</span>.</p>
</section>
<section id="tabulatedratingcurve" class="level3" data-number="2.5.3">
<h3 data-number="2.5.3" class="anchored" data-anchor-id="tabulatedratingcurve"><span class="header-section-number">2.5.3</span> TabulatedRatingCurve</h3>
<p>The Tabulated Rating Curve is a tabulation of a basin’s discharge behavior. It describes a piecewise linear relationship between the basin’s level and its discharge. It can be understood as an empirical description of a basin’s properties. This can include an outlet, but also the lumped hydraulic behavior of the upstream channels.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Currently, the discharge relies only on the basin’s level; it could also use the volume of both connected basins to simulate backwater effects, submersion of outlets, or even reversal of flows for high precipitation events.</p>
</div>
</div>
</section>
<section id="linearresistance" class="level3" data-number="2.5.4">
<h3 data-number="2.5.4" class="anchored" data-anchor-id="linearresistance"><span class="header-section-number">2.5.4</span> LinearResistance</h3>
<p>A <code>LinearResistance</code> connects two basins together. The flow between the two basins is determined by a linear relationship, up to an optional maximum flow rate:</p>
<p><span id="eq-basinflow"><span class="math display">\[
    Q = \mathrm{clamp}(\frac{h_a - h_b}{R}, -Q_{\max}, Q_{\max})
\tag{6}\]</span></span></p>
<p>Here <span class="math inline">\(h_a\)</span> is the water level in the first basin and <span class="math inline">\(h_b\)</span> is the water level in the second basin. <span class="math inline">\(R\)</span> is the resistance of the link, and <span class="math inline">\(Q_{\max}\)</span> is the maximum flow rate. A <code>LinearResistance</code> makes no assumptions about the direction of the flow: water flows from high to low.</p>
</section>
<section id="terminal" class="level3" data-number="2.5.5">
<h3 data-number="2.5.5" class="anchored" data-anchor-id="terminal"><span class="header-section-number">2.5.5</span> Terminal</h3>
<p>This only allows outflow from a basin into a terminal node.</p>
</section>
<section id="levelboundary" class="level3" data-number="2.5.6">
<h3 data-number="2.5.6" class="anchored" data-anchor-id="levelboundary"><span class="header-section-number">2.5.6</span> LevelBoundary</h3>
<p>This can be connected to a basin via a <code>LinearResistance</code>. This boundary node will then exchange water with the basin based on the difference in water level between the two.</p>
</section>
<section id="flowboundary" class="level3" data-number="2.5.7">
<h3 data-number="2.5.7" class="anchored" data-anchor-id="flowboundary"><span class="header-section-number">2.5.7</span> FlowBoundary</h3>
<p>This can be connected directly to a basin and prescribes the flow to or from that basin. We require that the edge connecting the flow boundary to the basin should point towards the basin, so that positive flow corresponds to water being added to the model.</p>
</section>
<section id="manning-connection" class="level3" data-number="2.5.8">
<h3 data-number="2.5.8" class="anchored" data-anchor-id="manning-connection"><span class="header-section-number">2.5.8</span> Manning connection</h3>
<p>Ribasim is capable of simulating steady flow between basins through a reach described by a trapezoidal profile and a Manning roughness coefficient.</p>
<p>We describe the discharge from basin <span class="math inline">\(a\)</span> to basin <span class="math inline">\(b\)</span> solely as a function of the water levels in <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span>.</p>
<p><span class="math display">\[
Q = f(h_a, h_b)
\]</span></p>
<p>where:</p>
<ul>
<li>The subscripts <span class="math inline">\(a,b\)</span> denote basins</li>
<li><span class="math inline">\(h\)</span> is the hydraulic head, or water level</li>
</ul>
<p>The energy equation for open channel flow is:</p>
<p><span class="math display">\[
H = h + \frac{v^2}{2g}
\]</span></p>
<p>Where</p>
<ul>
<li><span class="math inline">\(H\)</span> is total head</li>
<li><span class="math inline">\(v\)</span> is average water velocity</li>
<li><span class="math inline">\(g\)</span> is gravitational acceleration</li>
</ul>
<p>The discharge <span class="math inline">\(Q\)</span> is defined as:</p>
<p><span class="math display">\[
Q = Av
\]</span></p>
<p>where <span class="math inline">\(A\)</span> is cross-sectional area.</p>
<p>We use conservation of energy to relate the total head at <span class="math inline">\(a\)</span> to <span class="math inline">\(b\)</span>, with <span class="math inline">\(H_a &gt; H_b\)</span> as follows:</p>
<p><span class="math display">\[
H_a = H_b + h_{\text{loss}}
\]</span></p>
<p>Or:</p>
<p><span class="math display">\[
h_a + \frac{v_a^2}{2g} = h_b + \frac{v_b^2}{2g} + h_{\text{loss}}
\]</span></p>
<p>Where <span class="math inline">\(v\)</span> is the average water velocity. <span class="math inline">\(h_{\text{loss}}\)</span> is a combination of friction and contraction/expansion losses:</p>
<p><span class="math display">\[
h_{\text{loss}} = S_f L + \frac{C}{2g} \left(v_b^2 - v_a^2\right)
\]</span></p>
<p>Where:</p>
<ul>
<li><span class="math inline">\(L\)</span> is the reach length</li>
<li><span class="math inline">\(S_f\)</span> is the representative friction slope</li>
<li><span class="math inline">\(C\)</span> is the expansion or contraction coefficient, <span class="math inline">\(0 \le C \le1\)</span></li>
</ul>
<p>We assume velocity differences in a connection are negligible (<span class="math inline">\(v_a = v_b\)</span>):</p>
<p><span class="math display">\[
h_a = h_b + S_f L
\]</span></p>
<p>Friction losses are computed with the Gauckler-Manning formula:</p>
<p><span class="math display">\[
Q = \frac{A}{n} R_h^\frac{2}{3} \sqrt{S_f}
\]</span></p>
<p>Where:</p>
<ul>
<li><span class="math inline">\(A\)</span> is the <strong>representative</strong> area.</li>
<li><span class="math inline">\(R_h\)</span> is the <strong>representative</strong> wetted radius.</li>
<li><span class="math inline">\(S_f\)</span> is the <strong>representative</strong> friction slope.</li>
<li><span class="math inline">\(n\)</span> is Manning’s roughness coefficient.</li>
</ul>
<p>We can rewrite to express <span class="math inline">\(S_f\)</span> in terms of Q:</p>
<p><span class="math display">\[
S_f = Q^2 \frac{n^2}{A^2 R_h^{4/3}}
\]</span></p>
<p>No water is added or removed in a connection:</p>
<p><span class="math display">\[
Q_a = Q_b = Q
\]</span></p>
<p>Substituting:</p>
<p><span class="math display">\[
h_a = h_b + Q^2 \frac{n^2}{A^2 R_h^{4/3}} L
\]</span></p>
<p>We can then express <span class="math inline">\(Q\)</span> as a function of head difference <span class="math inline">\(\Delta h\)</span>:</p>
<p><span class="math display">\[
Q = \textrm{sign}(\Delta h) \frac{A}{n} R_h^{2/3}\sqrt{\frac{|\Delta h|}{L} }
\]</span></p>
<p>The <span class="math inline">\(\textrm{sign}(\Delta h)\)</span> term causes the direction of the flow to reverse if the head in basin <span class="math inline">\(b\)</span> is larger than in basin <span class="math inline">\(a\)</span>.</p>
<p>This expression however leads to problems in simulation since the derivative of <span class="math inline">\(Q\)</span> with respect to <span class="math inline">\(\Delta h\)</span> tends to <span class="math inline">\(\pm \infty\)</span> as <span class="math inline">\(\Delta h\)</span> tends to 0. Therefore we use the slightly modified expression</p>
<p><span class="math display">\[
Q = \textrm{sign}(\Delta h) \frac{A}{n} R_h^{2/3}\sqrt{\frac{\Delta h}{L} s(\Delta h)}
\]</span></p>
<p>to smooth out this problem. Here <span class="math inline">\(s(x) = \frac{2}{\pi}\arctan{1000x}\)</span> can be thought of as a smooth approximation of the sign function.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The computation of <span class="math inline">\(S_f\)</span> is not exact: we base it on a representative area and hydraulic radius, rather than integrating <span class="math inline">\(S_f\)</span> along the length of a reach. Direct analytic solutions exist for e.g.&nbsp;parabolic profiles (Tolkmitt), but other profiles requires relatively complicated approaches (such as approximating the profile with a polynomial).</p>
<p>We use the average value of the cross-sectional area, the average value of the water depth, and the average value of the hydraulic radius to compute a friction slope. The size of the resulting error will depend on the water depth difference between the upstream and downstream basin.</p>
</div>
</div>
<p>The cross sectional area for a trapezoidal or rectangular profile:</p>
<p><span class="math display">\[
A = w d + \frac{\Delta y}{\Delta z} d^2
\]</span></p>
<p>Where</p>
<ul>
<li><span class="math inline">\(w\)</span> is the width at <span class="math inline">\(d = 0\)</span> (A triangular profile has <span class="math inline">\(w = 0\)</span>)</li>
<li><span class="math inline">\(\frac{\Delta y}{\Delta z}\)</span> is the slope of the profile expressed as the horizontal length for one unit in the vertical (A slope of 45 degrees has <span class="math inline">\(\frac{\Delta y}{\Delta z} = 1\)</span>; a rectangular profile 0).</li>
</ul>
<p>Accordingly, the wetted perimeter is:</p>
<p><span class="math display">\[
B = w + 2 d \sqrt{\left(\frac{\Delta y}{\Delta z}\right)^2 + 1}
\]</span></p>
</section>
</section>
</section>
<section id="userdemand-allocation" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> UserDemand allocation</h1>
<p>UserDemands have an allocated flow rate <span class="math inline">\(F^p\)</span> per priority <span class="math inline">\(p=1,2,\ldots, p_{\max}\)</span>, which is either determined by <a href="../core/allocation.html">allocation optimization</a> or simply equal to the demand at time <span class="math inline">\(t\)</span>; <span class="math inline">\(F^p = d^p(t)\)</span>. The actual abstraction rate of a UserDemand is given by <span class="math display">\[
    Q_\text{userdemand, in} = \phi(u, 10.0)\phi(h-l_{\min}, 0.1)\sum_{p=1}^{p_{\max}} \min\left(F^p, d^p(t)\right).
\]</span></p>
<p>From left to right:</p>
<ul>
<li>The first reduction factor lets the UserDemand abstraction go smoothly to <span class="math inline">\(0\)</span> as the source Basin dries out;</li>
<li>The second reduction factor lets the UserDemand abstraction go smoothly to <span class="math inline">\(0\)</span> as the source Basin level approaches the minimum source Basin level (from above);</li>
<li>The last term is the sum of the allocations over the priorities. If the current demand happens to be lower than the allocation at some priority, the demand is taken instead.</li>
</ul>
<p>UserDemands also have a return factor <span class="math inline">\(0 \le r \le 1\)</span>, which determines the return flow (outflow) of the UserDemand:</p>
<p><span class="math display">\[
Q_\text{userdemand, out} = r \cdot Q_\text{userdemand, in}.
\]</span></p>
<p>Note that this means that the user_demand has a consumption rate of <span class="math inline">\((1-r)Q_\text{userdemand, in}\)</span>.</p>
</section>
<section id="sec-PID" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> PID controller</h1>
<p>The PID controller continuously sets the flow rate of a pump or outlet to bring the level of a certain basin closer to its setpoint. If we denote the setpoint by <span class="math inline">\(\text{SP}(t)\)</span> and the basin level by <span class="math inline">\(y(t)\)</span>, then the error is given by <span id="eq-error"><span class="math display">\[
e(t) = \text{SP}(t) - y(t).
\tag{7}\]</span></span></p>
<p>The output of the PID controller for the flow rate of the pump or outlet is then given by <span id="eq-PIDflow"><span class="math display">\[
    Q_\text{PID}(t) = K_p e(t) + K_i\int_{t_0}^t e(\tau)\text{d}\tau + K_d \frac{\text{d}e}{\text{d}t},
\tag{8}\]</span></span></p>
<p>for given constant parameters <span class="math inline">\(K_p,K_i,K_d\)</span>. The pump or outlet can have associated minimum and maximum flow rates <span class="math inline">\(Q_{\min}, Q_{\max}\)</span>, and so <span class="math display">\[
Q_\text{pump/outlet} = \text{clip}(\Phi Q_\text{PID}; Q_{\min}, Q_{\max}).
\]</span></p>
<p>Here <span class="math inline">\(u_\text{us}\)</span> is the storage of the basin upstream of the pump or outlet, <span class="math inline">\(\Phi\)</span> is the product of <a href="../core/equations.html#sec-reduction_factor">reduction factors</a> associated with the <a href="../core/equations.html#sec-pump">pump</a> or <a href="../core/equations.html#sec-outlet">outlet</a> and</p>
<p><span class="math display">\[\begin{align}
    \text{clip}(Q; Q_{\min}, Q_{\max}) =
    \begin{cases}
        Q_{\min} &amp; \text{if} \quad Q &lt; Q_{\min} \\
        Q &amp; \text{if} \quad Q_{\min} \leq Q \leq Q_{\max} \\
        Q_{\max} &amp; \text{if} \quad Q &gt; Q_{\max}
    \end{cases}.
\end{align}\]</span></p>
<p>For the integral term we denote <span class="math display">\[
I(t) = \int_{t_0}^t e(\tau)\text{d}\tau,
\]</span></p>
<p>where <span class="math inline">\(t_0\)</span> is the last time the PID controller was made active. <span class="math inline">\(I(t)\)</span> is treated as a state of the system and thus it has its own equation in the system in <a href="#eq-system" class="quarto-xref">Equation&nbsp;1</a>: <span class="math display">\[
\frac{\text{d}I}{\text{d}t} = e(t).
\]</span></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>In the case of the controlled outlet, the upstream node can also be a level boundary. In this case we define <span class="math inline">\(\phi = 1\)</span>.</p>
</div>
</div>
<section id="the-derivative-term" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="the-derivative-term"><span class="header-section-number">4.1</span> The derivative term</h2>
<p>When <span class="math inline">\(K_d \ne 0\)</span> this adds a level of complexity. We can see this by looking at the error derivative more closely: <span class="math display">\[
\frac{\text{d}e}{\text{d}t} = \frac{\text{d}\text{SP}}{\text{d}t} - \frac{1}{A(u_\text{PID})}\frac{\text{d}u_\text{PID}}{\text{d}t},
\]</span> where <span class="math inline">\(A(u_\text{PID})\)</span> is the area of the controlled basin as a function of the storage of the controlled basin <span class="math inline">\(u_\text{PID}\)</span>. The complexity arises from the fact that <span class="math inline">\(Q_\text{PID}\)</span> is a contribution to <span class="math inline">\(\frac{\text{d}u_\text{PID}}{\text{d}t} = f_\text{PID}\)</span>, which makes <a href="#eq-PIDflow" class="quarto-xref">Equation&nbsp;8</a> an implicit equation for <span class="math inline">\(Q_\text{PID}\)</span>. We define</p>
<p><span class="math display">\[
f_\text{PID} = \hat{f}_\text{PID} \pm Q_\text{pump/outlet},
\]</span></p>
<p>that is, <span class="math inline">\(\hat{f}_\text{PID}\)</span> is the right hand side of the ODE for the controlled basin storage state without the contribution of the PID controlled pump. The plus sign holds for an outlet and the minus sign for a pump, dictated by the way the pump and outlet connectivity to the controlled basin is enforced.</p>
<p>Using this, solving <a href="#eq-PIDflow" class="quarto-xref">Equation&nbsp;8</a> for <span class="math inline">\(Q_\text{PID}\)</span> yields <span class="math display">\[
Q_\text{pump/outlet} = \text{clip}\left(\phi(u_\text{us})\frac{K_pe + K_iI + K_d \left(\frac{\text{d}\text{SP}}{\text{d}t}-\frac{\hat{f}_\text{PID}}{A(u_\text{PID})}\right)}{1\pm\phi(u_\text{us})\frac{K_d}{A(u_\text{PID})}};Q_{\min},Q_{\max}\right),
\]</span> where the clipping is again done last. Note that to compute this, <span class="math inline">\(\hat{f}_\text{PID}\)</span> has to be known first, meaning that the PID controlled pump/outlet flow rate has to be computed after all other contributions to the PID controlled basin’s storage are known.</p>
</section>
<section id="the-sign-of-the-parameters" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="the-sign-of-the-parameters"><span class="header-section-number">4.2</span> The sign of the parameters</h2>
<p>Note by <a href="#eq-error" class="quarto-xref">Equation&nbsp;7</a> that the error is positive if the setpoint is larger than the basin level and negative if the setpoint is smaller than the basin level.</p>
<p>We enforce the convention that when a pump is controlled, its edge points away from the basin, and when an outlet is controlled, its edge points towards the basin, so that the main flow direction along these edges is positive. Therefore, positive flows of the pump and outlet have opposite effects on the basin, and thus the parameters <span class="math inline">\(K_p,K_i,K_d\)</span> of the pump and outlet must have oppositive signs to achieve the same goal.</p>
</section>
</section>
<section id="numerical-solution" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Numerical solution</h1>
<p>Ribasim uses OrdinaryDiffEq.jl to provide a numerical solution to the water balance equations. Changes to forcings or parameters such as precipitation, but also the allocated water abstraction is managed through the use of CallBack functions <span class="citation" data-cites="callbacks">(<a href="#ref-callbacks" role="doc-biblioref">SciML Development Team 2022</a>)</span>. In a coupled run, the exchanges with MODFLOW 6 are also managed via the use of a callback function. For more a more in-depth discussion of numerical computations see <a href="../core/numerics.html">Numerical considerations</a>.</p>
</section>
<section id="performance" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Performance</h1>
<p>Ribasim needs to be sufficiently fast to make application on the national scale, with ~10000 basins, practical. Therefore, whilst developing, we need to be mindful that our approach can scale to such a size. We currently simulate a set of 40 connected free-flowing basins for a period of 2 years in about 10 seconds.</p>
<p>For a real scaling test we would need to do a national simulation, but we expect these computation times not to be problematic, considering that simulating those same 40 basins in MODFLOW 6 takes minutes.</p>
<p>There are many things that can influence the calculations times, for instance:</p>
<ul>
<li><a href="https://diffeq.sciml.ai/stable/basics/faq/#What-does-tolerance-mean-and-how-much-error-should-I-expect">Solver tolerance</a> we currently use a very conservative tolerance of <code>1e-10</code>, whereas with larger tolerances step sizes can easily be 3x longer, leading to a 3x speedup.</li>
<li><a href="https://diffeq.sciml.ai/stable/solvers/ode_solve/">ODE solvers</a>: The <code>Rosenbrock23</code> method we use is robust to oscillations and massive stiffness, however other solvers should be tried as well.</li>
<li>Forcing: Every time new forcing data is injected into the model, it needs to pause. Moreover, the larger the forcing fluxes are, the bigger the shock to the system, leading to smaller timesteps and thus longer simulation times.</li>
</ul>
<p>Similarly to other models that solve using a system of equations, like MODFLOW 6, if one basin takes longer to converge due to extreme forcing, or bad schematization, the system as a whole need to iterate longer. It is important to be mindful of this, as poor schematization choices can slow down the model.</p>
<p>When scaling up the model, we will need spend some time to strike the right balance between error tolerance, schematization and forcing. The SciML software we use has many <a href="https://sciml.ai/showcase/">showcases</a> of large scale applications, as well as documentation on how to achieve the optimal performance for your system.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-callbacks" class="csl-entry" role="listitem">
SciML Development Team. 2022. <span>“Event Handling and Callback Functions.”</span> <a href="https://docs.sciml.ai/DiffEqDocs/latest/features/callback_functions/">https://docs.sciml.ai/DiffEqDocs/latest/features/callback_functions/</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../core/validation.html" class="pagination-link" aria-label="Validation">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Validation</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../core/allocation.html" class="pagination-link" aria-label="Allocation">
        <span class="nav-page-text">Allocation</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>