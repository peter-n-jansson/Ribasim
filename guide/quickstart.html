<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.55">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Quick start guide – Ribasim</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../guide/examples.html" rel="next">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../assets/styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="https://user-images.githubusercontent.com/4471859/224825908-bee7e044-bc6b-4561-8b08-5d330cce3ed5.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Ribasim</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Overview</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../guide/quickstart.html" aria-current="page"> 
<span class="menu-text">How-to guides</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../concept/concept.html"> 
<span class="menu-text">Concepts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../reference/index.html"> 
<span class="menu-text">Reference</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../dev/index.html"> 
<span class="menu-text">Contributing</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/Deltares/Ribasim"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../guide/quickstart.html">Quick start guide</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../guide/quickstart.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Quick start guide</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../guide/examples.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Examples</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../guide/qgis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">QGIS plugin</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../guide/coupling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Coupling</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Coupling guides</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../guide/delwaq.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Ribasim Delwaq coupling</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a>
  <ul class="collapse">
  <li><a href="#learning-objectives" id="toc-learning-objectives" class="nav-link" data-scroll-target="#learning-objectives"><span class="header-section-number">1.1</span> Learning objectives</a></li>
  </ul></li>
  <li><a href="#starting-ribasim" id="toc-starting-ribasim" class="nav-link" data-scroll-target="#starting-ribasim"><span class="header-section-number">2</span> Starting RIBASIM</a>
  <ul class="collapse">
  <li><a href="#system-requirements" id="toc-system-requirements" class="nav-link" data-scroll-target="#system-requirements"><span class="header-section-number">2.1</span> System requirements</a></li>
  <li><a href="#installation" id="toc-installation" class="nav-link" data-scroll-target="#installation"><span class="header-section-number">2.2</span> Installation</a></li>
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation"><span class="header-section-number">2.3</span> Data preparation</a></li>
  </ul></li>
  <li><a href="#modual-1---crystal-river-basin" id="toc-modual-1---crystal-river-basin" class="nav-link" data-scroll-target="#modual-1---crystal-river-basin"><span class="header-section-number">3</span> Modual 1 - Crystal River Basin</a>
  <ul class="collapse">
  <li><a href="#modual-1.1---natural-flow" id="toc-modual-1.1---natural-flow" class="nav-link" data-scroll-target="#modual-1.1---natural-flow"><span class="header-section-number">3.1</span> Modual 1.1 - Natural Flow</a>
  <ul class="collapse">
  <li><a href="#step-1-import-packages" id="toc-step-1-import-packages" class="nav-link" data-scroll-target="#step-1-import-packages"><span class="header-section-number">3.1.1</span> Step 1: Import packages</a></li>
  <li><a href="#step-2-setup-paths-and-model-configuration" id="toc-step-2-setup-paths-and-model-configuration" class="nav-link" data-scroll-target="#step-2-setup-paths-and-model-configuration"><span class="header-section-number">3.1.2</span> Step 2: Setup paths and model configuration</a></li>
  <li><a href="#step-3-flow-boundary-nodes" id="toc-step-3-flow-boundary-nodes" class="nav-link" data-scroll-target="#step-3-flow-boundary-nodes"><span class="header-section-number">3.1.3</span> Step 3: Flow boundary nodes</a></li>
  <li><a href="#step-4-basin-node-confluence" id="toc-step-4-basin-node-confluence" class="nav-link" data-scroll-target="#step-4-basin-node-confluence"><span class="header-section-number">3.1.4</span> Step 4: Basin node (confluence)</a></li>
  <li><a href="#step-5-tabulated-rating-curve" id="toc-step-5-tabulated-rating-curve" class="nav-link" data-scroll-target="#step-5-tabulated-rating-curve"><span class="header-section-number">3.1.5</span> Step 5: Tabulated rating curve</a></li>
  <li><a href="#step-6-terminal-node" id="toc-step-6-terminal-node" class="nav-link" data-scroll-target="#step-6-terminal-node"><span class="header-section-number">3.1.6</span> Step 6: Terminal node</a></li>
  <li><a href="#step-7-defining-edges" id="toc-step-7-defining-edges" class="nav-link" data-scroll-target="#step-7-defining-edges"><span class="header-section-number">3.1.7</span> Step 7: Defining edges</a></li>
  <li><a href="#step-8-visualization-and-model-execution" id="toc-step-8-visualization-and-model-execution" class="nav-link" data-scroll-target="#step-8-visualization-and-model-execution"><span class="header-section-number">3.1.8</span> Step 8: Visualization and model execution</a></li>
  <li><a href="#step-9-post-processing-results" id="toc-step-9-post-processing-results" class="nav-link" data-scroll-target="#step-9-post-processing-results"><span class="header-section-number">3.1.9</span> Step 9: Post-processing results</a></li>
  </ul></li>
  <li><a href="#modual-1.2---irrigation-demand" id="toc-modual-1.2---irrigation-demand" class="nav-link" data-scroll-target="#modual-1.2---irrigation-demand"><span class="header-section-number">3.2</span> Modual 1.2 - Irrigation demand</a>
  <ul class="collapse">
  <li><a href="#step-1-setup-the-model-adjust-import-packages" id="toc-step-1-setup-the-model-adjust-import-packages" class="nav-link" data-scroll-target="#step-1-setup-the-model-adjust-import-packages"><span class="header-section-number">3.2.1</span> Step 1: Setup the model &amp; adjust Import Packages</a></li>
  <li><a href="#step-2-add-a-second-basin-node" id="toc-step-2-add-a-second-basin-node" class="nav-link" data-scroll-target="#step-2-add-a-second-basin-node"><span class="header-section-number">3.2.2</span> Step 2: Add a second Basin node</a></li>
  <li><a href="#step-3-add-the-irrigation-demand" id="toc-step-3-add-the-irrigation-demand" class="nav-link" data-scroll-target="#step-3-add-the-irrigation-demand"><span class="header-section-number">3.2.3</span> Step 3: Add the irrigation demand</a></li>
  <li><a href="#step-4-add-a-tabulated-rating-curve" id="toc-step-4-add-a-tabulated-rating-curve" class="nav-link" data-scroll-target="#step-4-add-a-tabulated-rating-curve"><span class="header-section-number">3.2.4</span> Step 4: Add a tabulated rating curve</a></li>
  <li><a href="#step-5-adjust-the-terminal-node-id-and-edges" id="toc-step-5-adjust-the-terminal-node-id-and-edges" class="nav-link" data-scroll-target="#step-5-adjust-the-terminal-node-id-and-edges"><span class="header-section-number">3.2.5</span> Step 5: Adjust the terminal node id and edges</a></li>
  <li><a href="#step-6-plot-model-and-run" id="toc-step-6-plot-model-and-run" class="nav-link" data-scroll-target="#step-6-plot-model-and-run"><span class="header-section-number">3.2.6</span> Step 6: Plot model and run</a></li>
  <li><a href="#step-7-name-the-edges-and-basins" id="toc-step-7-name-the-edges-and-basins" class="nav-link" data-scroll-target="#step-7-name-the-edges-and-basins"><span class="header-section-number">3.2.7</span> Step 7: Name the edges and basins</a></li>
  <li><a href="#step-8-plot-and-compare-the-basin-results" id="toc-step-8-plot-and-compare-the-basin-results" class="nav-link" data-scroll-target="#step-8-plot-and-compare-the-basin-results"><span class="header-section-number">3.2.8</span> Step 8: Plot and compare the basin results</a></li>
  <li><a href="#step-9-plot-and-compare-the-flow-results" id="toc-step-9-plot-and-compare-the-flow-results" class="nav-link" data-scroll-target="#step-9-plot-and-compare-the-flow-results"><span class="header-section-number">3.2.9</span> Step 9: Plot and compare the flow results</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#modual-2-reservoirs-and-public-water-supply" id="toc-modual-2-reservoirs-and-public-water-supply" class="nav-link" data-scroll-target="#modual-2-reservoirs-and-public-water-supply"><span class="header-section-number">4</span> Modual 2 – Reservoirs and Public Water Supply</a>
  <ul class="collapse">
  <li><a href="#modual-2.1-reservoir" id="toc-modual-2.1-reservoir" class="nav-link" data-scroll-target="#modual-2.1-reservoir"><span class="header-section-number">4.1</span> Modual 2.1 – Reservoir</a>
  <ul class="collapse">
  <li><a href="#step-1-add-a-basin" id="toc-step-1-add-a-basin" class="nav-link" data-scroll-target="#step-1-add-a-basin"><span class="header-section-number">4.1.1</span> Step 1: Add a basin</a></li>
  <li><a href="#step-2-adjust-the-code" id="toc-step-2-adjust-the-code" class="nav-link" data-scroll-target="#step-2-adjust-the-code"><span class="header-section-number">4.1.2</span> Step 2: Adjust the code</a></li>
  <li><a href="#step-3-plotting-results" id="toc-step-3-plotting-results" class="nav-link" data-scroll-target="#step-3-plotting-results"><span class="header-section-number">4.1.3</span> Step 3: Plotting results</a></li>
  </ul></li>
  <li><a href="#module-2.2-public-water-supply" id="toc-module-2.2-public-water-supply" class="nav-link" data-scroll-target="#module-2.2-public-water-supply"><span class="header-section-number">4.2</span> Module 2.2 – Public Water Supply</a>
  <ul class="collapse">
  <li><a href="#step-1-rename-the-saving-files" id="toc-step-1-rename-the-saving-files" class="nav-link" data-scroll-target="#step-1-rename-the-saving-files"><span class="header-section-number">4.2.1</span> Step 1: Rename the saving files</a></li>
  <li><a href="#step-2-add-a-demand-node" id="toc-step-2-add-a-demand-node" class="nav-link" data-scroll-target="#step-2-add-a-demand-node"><span class="header-section-number">4.2.2</span> Step 2: Add a demand node</a></li>
  <li><a href="#step-3-add-the-edges" id="toc-step-3-add-the-edges" class="nav-link" data-scroll-target="#step-3-add-the-edges"><span class="header-section-number">4.2.3</span> Step 3: Add the edges</a></li>
  <li><a href="#step-4-adjust-the-name-dictionaries" id="toc-step-4-adjust-the-name-dictionaries" class="nav-link" data-scroll-target="#step-4-adjust-the-name-dictionaries"><span class="header-section-number">4.2.4</span> Step 4: Adjust the name dictionaries</a></li>
  <li><a href="#step-5-check-the-simulated-demands" id="toc-step-5-check-the-simulated-demands" class="nav-link" data-scroll-target="#step-5-check-the-simulated-demands"><span class="header-section-number">4.2.5</span> Step 5: Check the simulated demands</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Quick start guide</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="https://github.com/user-attachments/assets/467e71da-def4-4723-91de-f76bf78758fe.png" class="img-fluid quarto-figure quarto-figure-left figure-img"></p>
</figure>
</div>
<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>Welcome to Ribasim! This guide will help you get started with the basics of installing and using Ribasim for river basin simulation. In this guide, the schematization of models will be implemented in Python using the Ribasim Python package. The Ribasim package (named <code>ribasim</code>) simplifies the process of building, updating, and analyzing Ribasim model programmatically. It also allows for the creation of entire models from base data, ensuring that your model setup is fully reproducible. This package is available on PyPI.</p>
<section id="learning-objectives" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="learning-objectives"><span class="header-section-number">1.1</span> Learning objectives</h2>
<p>In this guide, we will focus on a fictional river basin called Crystal, which will serve as our case study. The guide is divided into different modules, each covering various scenarios. These include simulating natural flow, implementing reservoirs, and observing the impact of other structures. While not all node types and possibilities will be demonstrated, the focus will be on the most commonly used and significant situations. By the end of the guide, users will be able to:</p>
<ul>
<li><strong>Set Up a Basic Ribasim Model</strong>: Understand how to create a new model for a river basin using the Ribasim Python package.</li>
<li><strong>Evaluate the Impact of Demands</strong>: Introduce water demand (such as irrigation) and assess their effects on the river basin.</li>
<li><strong>Modify and Update Models</strong>: Learn how to update existing models with new data and changes.</li>
<li><strong>Analyze Simulation Results</strong>: Use built-in tools to analyze and interpret the results of your simulations.</li>
</ul>
</section>
</section>
<section id="starting-ribasim" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Starting RIBASIM</h1>
<section id="system-requirements" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="system-requirements"><span class="header-section-number">2.1</span> System requirements</h2>
<p>Before installing Ribasim, ensure your system meets the following requirements:</p>
<ul>
<li>Operating System: Windows 10 or later, or Linux (latest distributions)</li>
<li>Processor: x86-64 (64-bit)</li>
<li>RAM: 4 GB minimum, 8 GB recommended</li>
<li>Hard Drive: 1GB of free space</li>
</ul>
</section>
<section id="installation" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="installation"><span class="header-section-number">2.2</span> Installation</h2>
<ol type="1">
<li>Download Ribasim: Obtain the Ribasim 9 installation package from the official website: <a href="https://ribasim.org/install.html">Ribasim - Installation</a> under chapter ‘2 Download’:</li>
</ol>
<ul>
<li>For Windows download: <code>ribasim_windows.zip</code></li>
<li>For Linux: <code>ribasim_linux.zip</code></li>
</ul>
<ol start="2" type="1">
<li>Unpack the <code>.zip</code> archive: It is important to keep the contents of the zip file organized within a single directory. The Ribasim executable can be found in the directory;</li>
<li>Check installation: To check whether the installation was performed successfully, in <code>cmd</code> go to the executable path and type <code>ribasim</code> with no arguments in the command line. This will give the following message:</li>
</ol>
<pre class="batch"><code>error: the following required arguments were not provided:
 &lt;TOML_PATH&gt;
Usage: ribasim &lt;TOML_PATH&gt;
For more information, try '--help'.</code></pre>
<ol start="4" type="1">
<li>We use a command line interface (CLI) to install our Ribasim packages. To install Ribasim open PowerShell or Windows command prompt and write:</li>
</ol>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> install ribasim</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>or</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mamba</span> install ribasim</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="data-preparation" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="data-preparation"><span class="header-section-number">2.3</span> Data preparation</h2>
<p>Download the <code>Crystal_Basin.zip</code> file from the website. Extract <code>Crystal_Basin.zip</code> and place it in the same directory as your Ribasim installation. This folder includes:</p>
<ul>
<li><code>QuickStartGuide.pdf</code></li>
<li><code>data</code>: Contains data inputs such as time series needed for running the case. Additionally, your Python model (<code>.py</code>) and eventually the output files will also be saved in this folder.</li>
</ul>
</section>
</section>
<section id="modual-1---crystal-river-basin" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Modual 1 - Crystal River Basin</h1>
<p>We will examine a straightforward example of the Crystal River Basin, which includes a main river and a single tributary flowing into the sea (see <a href="#fig-crystal-basin" class="quarto-xref">Figure&nbsp;1</a>). An average discharge of <span class="math inline">\(44.45  \text{ m}^3/\text{s}\)</span> is measured at the confluence. In this module, the basin is free of any activities, allowing the model to simulate the natural flow. The next step is to include a demand (irrigation) that taps from a canal out of the main river.</p>
<div id="fig-crystal-basin" class="quarto-float quarto-figure quarto-figure-left anchored" data-fig-align="left">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-crystal-basin-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://github.com/user-attachments/assets/e7c4e14c-07ca-416a-877f-9ea0459bdf3d.png" class="img-fluid quarto-figure quarto-figure-left figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-crystal-basin-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Crystal Basin based on natural flow
</figcaption>
</figure>
</div>
<p>After this module the user will be able to:</p>
<ul>
<li>Build a river basin model from scratch</li>
<li>Understand the functionality of the ‘demand’ and ‘basin’ nodes</li>
<li>Generate overview of results</li>
<li>Evaluate the simulation results</li>
</ul>
<section id="modual-1.1---natural-flow" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="modual-1.1---natural-flow"><span class="header-section-number">3.1</span> Modual 1.1 - Natural Flow</h2>
<section id="step-1-import-packages" class="level3" data-number="3.1.1">
<h3 data-number="3.1.1" class="anchored" data-anchor-id="step-1-import-packages"><span class="header-section-number">3.1.1</span> Step 1: Import packages</h3>
<p>Before building the model we need to import some modules. Open your python platform (Spyder, VS code etc.), created a new file and name it <code>Crystal_1.1</code> and save it into your model folder <code>Crystal_Basin</code>. Import the following modules in python:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pathlib</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ribasim <span class="im">import</span> Allocation, Model, Node <span class="co"># The main library used for river basin modeling.</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ribasim.nodes <span class="im">import</span> (</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    flow_boundary,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    basin,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    tabulated_rating_curve,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    terminal</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.geometry <span class="im">import</span> Point</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess  <span class="co"># For running the model</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-2-setup-paths-and-model-configuration" class="level3" data-number="3.1.2">
<h3 data-number="3.1.2" class="anchored" data-anchor-id="step-2-setup-paths-and-model-configuration"><span class="header-section-number">3.1.2</span> Step 2: Setup paths and model configuration</h3>
<p>Reference the paths of the Ribasim installation and model directory and define the time period (2022-01-01 until 2023-01-01) for the model simulation:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>base_dir <span class="op">=</span> Path(<span class="st">"c:/Ribasim"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>model_dir <span class="op">=</span> base_dir <span class="op">/</span> <span class="st">"Crystal_Basin"</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>data_path <span class="op">=</span> model_dir <span class="op">/</span> <span class="st">"data/input/ACTINFLW.csv"</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>starttime <span class="op">=</span> <span class="st">"2022-01-01"</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>endtime <span class="op">=</span> <span class="st">"2023-01-01"</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Model(</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    starttime<span class="op">=</span>starttime,</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    endtime<span class="op">=</span>endtime,</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    crs<span class="op">=</span><span class="st">"EPSG:4326"</span>,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-3-flow-boundary-nodes" class="level3" data-number="3.1.3">
<h3 data-number="3.1.3" class="anchored" data-anchor-id="step-3-flow-boundary-nodes"><span class="header-section-number">3.1.3</span> Step 3: Flow boundary nodes</h3>
<p>Crystal Basin consists of two inflow points, the tributary and the main Crystal river, we will call them <code>Minor</code> and <code>Main</code> respectively. In order to define the time series flow rate (<span class="math inline">\(\text{m}^3/\text{s}\)</span>) we read the discharge data from <code>ACTINFLW.csv</code>. This inflow data goes monthly from 2014 to 2023. However, for this exercise actual runtime is already defined in step 2.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> pd.read_csv(data_path, sep<span class="op">=</span><span class="st">";"</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>data[<span class="st">'sum'</span>]<span class="op">=</span> data[<span class="st">'minor'</span>]<span class="op">+</span>data[<span class="st">'main'</span>]</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">#Average inflow and max. of the whole summed inflow data timeseries</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">#From 2014 - 2023</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Average inflowQ m3/s:'</span>,data[<span class="st">'sum'</span>].mean())</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Average inflowQ m3/s:'</span>,data[<span class="st">'sum'</span>].<span class="bu">max</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>model.flow_boundary.add(</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    Node(<span class="dv">1</span>, Point(<span class="fl">0.0</span>, <span class="fl">0.0</span>), name<span class="op">=</span><span class="st">'Main'</span>),</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    [flow_boundary.Time(time<span class="op">=</span>data.time, flow_rate<span class="op">=</span>data.main,</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    )]</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>model.flow_boundary.add(</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    Node(<span class="dv">2</span>, Point(<span class="op">-</span><span class="fl">3.0</span>, <span class="fl">0.0</span>), name<span class="op">=</span><span class="st">'Minor'</span>),</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    [flow_boundary.Time(time<span class="op">=</span>data.time, flow_rate<span class="op">=</span>data.minor,</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    )]</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-4-basin-node-confluence" class="level3" data-number="3.1.4">
<h3 data-number="3.1.4" class="anchored" data-anchor-id="step-4-basin-node-confluence"><span class="header-section-number">3.1.4</span> Step 4: Basin node (confluence)</h3>
<p>To schematize the confluence from the tributary we will use the Basin node. The node by itself portrays as a bucket with a certain volume of water and can be used for different purposes, such as a reservoir, a lake or in this case a confluence. <a href="#fig-confluence" class="quarto-xref">Figure&nbsp;2</a> visualizes a cross section of the confluence point in our model.</p>
<div id="fig-confluence" class="quarto-float quarto-figure quarto-figure-left anchored" data-fig-align="left">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-confluence-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://github.com/user-attachments/assets/3a6b05d9-c535-4054-be92-c593a0c03d93.png" class="img-fluid quarto-figure quarto-figure-left figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-confluence-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Basin node concept for the confluence
</figcaption>
</figure>
</div>
<p><a href="#tbl-input1" class="quarto-xref">Table&nbsp;1</a> shows the input data for the basin node profile.</p>
<div id="tbl-input1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-input1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Profile data for the basin node
</figcaption>
<div aria-describedby="tbl-input1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top">
<thead>
<tr>
<th>Area [<span class="math inline">\(\text{m}^2\)</span>]</th>
<th>Level [<span class="math inline">\(\text{m}\)</span>]</th>
</tr>
</thead>
<tbody>
<tr>
<td><span class="math inline">\(672000.0\)</span></td>
<td><span class="math inline">\(0.0\)</span></td>
</tr>
<tr>
<td><span class="math inline">\(5600000.0\)</span></td>
<td><span class="math inline">\(6.0\)</span></td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>To specify the basin profile, the following code is used:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>model.basin.add(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    Node(<span class="dv">3</span>, Point(<span class="op">-</span><span class="fl">1.5</span>, <span class="op">-</span><span class="dv">1</span>), name<span class="op">=</span><span class="st">'Conf'</span>),</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    [basin.Profile(area<span class="op">=</span>[<span class="dv">672000</span>, <span class="dv">5600000</span>], level<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">6</span>]),</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>     basin.State(level<span class="op">=</span>[<span class="dv">4</span>]),</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>     basin.Time(time<span class="op">=</span>[starttime, endtime]),</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-5-tabulated-rating-curve" class="level3" data-number="3.1.5">
<h3 data-number="3.1.5" class="anchored" data-anchor-id="step-5-tabulated-rating-curve"><span class="header-section-number">3.1.5</span> Step 5: Tabulated rating curve</h3>
<p>In the previous step we implemented a Basin node that functions as a confluence. Conceptually, the basin acts like a bucket of water, accumulating inflows and then releasing them. However, the model does not run if the basin is directly connected to the terminal node. This is because, for the model to function properly, we need to define a relation between the water level (<span class="math inline">\(h\)</span>) in the basin and the outflow (<span class="math inline">\(Q\)</span>) from the basin. This relation is defined by the <code>Tabulated Rating Curve</code> and thus serves as a critical component. This setup mimics the behavior of a gate or spillway, allowing us to model how varying water levels influence flow rates at the confluence.</p>
<p>As the two inflows come together at the confluence, we expect, as mentioned and coded before, a discharge average of <span class="math inline">\(44.45 \text{ m}^3/\text{s}\)</span>. It is therefore expected that the confluence basin reaches a level where the outflow is equal to the inflow via the rating curve. Only then is the confluence basin in equilibrium. To ensure that inflow equals outflow (IN=OUT) and keeping in mind the maximum depth of the river is <span class="math inline">\(6 \text{ m}\)</span>, the <span class="math inline">\(Q(h)\)</span> relationship in <a href="#tbl-input2" class="quarto-xref">Table&nbsp;2</a> will be used as input.</p>
<div id="tbl-input2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-input2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Input data for the Tabulated Rating Curve
</figcaption>
<div aria-describedby="tbl-input2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top">
<colgroup>
<col style="width: 44%">
<col style="width: 55%">
</colgroup>
<thead>
<tr>
<th>Water Level (<span class="math inline">\(h\)</span>) [<span class="math inline">\(\text{m}\)</span>]</th>
<th>Outflow (<span class="math inline">\(Q\)</span>) [<span class="math inline">\(\text{m}^3/\text{s}\)</span>]</th>
</tr>
</thead>
<tbody>
<tr>
<td><span class="math inline">\(0.0\)</span></td>
<td><span class="math inline">\(0.0\)</span></td>
</tr>
<tr>
<td><span class="math inline">\(2.0\)</span></td>
<td><span class="math inline">\(50.0\)</span></td>
</tr>
<tr>
<td><span class="math inline">\(5.0\)</span></td>
<td><span class="math inline">\(200.0\)</span></td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>In Ribasim, the <span class="math inline">\(Q(h)\)</span> relation is a linear function, so the points in between will be linearly interpolated. <a href="#fig-discharge" class="quarto-xref">Figure&nbsp;3</a> illustrates the visual process and shows a progressive increase in discharge with rising water levels. In this case this means:</p>
<ul>
<li>At level <span class="math inline">\(0.0\)</span>: No discharge occurs. This represents a condition where the water level is too low for any flow to be discharged.</li>
<li>At level <span class="math inline">\(2.0\)</span>: Discharge is max. <span class="math inline">\(50.0 \text{ m}^3/\text{s}\)</span>. This is a bit above the average discharge rate, corresponding to the water level where normal flow conditions are established.</li>
<li>At level <span class="math inline">\(5.0\)</span>: Discharge rate reaches <span class="math inline">\(200.0 \text{ m}^3/\text{s}\)</span>. This discharge rate occurs at the water level during wet periods, indicating higher flow capacity.</li>
</ul>
<div id="fig-discharge" class="quarto-float quarto-figure quarto-figure-left anchored" data-fig-align="left">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-discharge-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://github.com/user-attachments/assets/14799746-3b4d-4d4c-9b8a-37fbe1d88081.png" class="img-fluid quarto-figure quarto-figure-left figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-discharge-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Discharge at corresponding water levels
</figcaption>
</figure>
</div>
<p>Taking this into account, add the <code>Tabulated Rating Curve</code> as follows:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>model.tabulated_rating_curve.add(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    Node(<span class="dv">4</span>, Point(<span class="op">-</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">1.5</span>), name<span class="op">=</span><span class="st">'MainConf'</span>),</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    [tabulated_rating_curve.Static(</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        level<span class="op">=</span>[<span class="fl">0.0</span>, <span class="dv">2</span>, <span class="dv">5</span>],</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        flow_rate<span class="op">=</span>[<span class="fl">0.0</span>, <span class="dv">50</span>, <span class="dv">200</span>],</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-6-terminal-node" class="level3" data-number="3.1.6">
<h3 data-number="3.1.6" class="anchored" data-anchor-id="step-6-terminal-node"><span class="header-section-number">3.1.6</span> Step 6: Terminal node</h3>
<p>Finally all the water will discharge into the ocean. Schematize this with the terminal node as it portrays the end point of the model. Besides the node number/name and location, no further input is needed.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>model.terminal.add(Node(<span class="dv">5</span>, Point(<span class="op">-</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">3.0</span>), name<span class="op">=</span><span class="st">"Terminal"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-7-defining-edges" class="level3" data-number="3.1.7">
<h3 data-number="3.1.7" class="anchored" data-anchor-id="step-7-defining-edges"><span class="header-section-number">3.1.7</span> Step 7: Defining edges</h3>
<p>Implement the connections (edges) between the nodes, in the following order:</p>
<ol type="1">
<li>Flow boundaries to the basin;</li>
<li>Basin to the rating curve;</li>
<li>Tabulated rating curve to the terminal.</li>
</ol>
<div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>model.edge.add(model.flow_boundary[<span class="dv">1</span>], model.basin[<span class="dv">3</span>])</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>model.edge.add(model.flow_boundary[<span class="dv">2</span>], model.basin[<span class="dv">3</span>])</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>model.edge.add(model.basin[<span class="dv">3</span>], model.tabulated_rating_curve[<span class="dv">4</span>])</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>model.edge.add(model.tabulated_rating_curve[<span class="dv">4</span>], model.terminal[<span class="dv">5</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-8-visualization-and-model-execution" class="level3" data-number="3.1.8">
<h3 data-number="3.1.8" class="anchored" data-anchor-id="step-8-visualization-and-model-execution"><span class="header-section-number">3.1.8</span> Step 8: Visualization and model execution</h3>
<p>Plot the schematization, write the model configuration to the <code>TOML</code> file. Name the output file <code>Crystal_1.1/ribasim.toml</code>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>model.plot()</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>toml_path <span class="op">=</span> model_dir<span class="op">/</span> <span class="st">"Crystal_1.1/ribasim.toml"</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>model.write(toml_path)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>rib_path <span class="op">=</span> base_dir <span class="op">/</span> <span class="st">"ribasim_windows/ribasim.exe"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The schematization should look like <a href="#fig-cs11" class="quarto-xref">Figure&nbsp;4</a>.</p>
<div id="fig-cs11" class="quarto-float quarto-figure quarto-figure-left anchored" data-fig-align="left">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cs11-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://github.com/user-attachments/assets/c3bfceb8-6da0-46d3-9ded-e7a039d874ec.png" class="img-fluid quarto-figure quarto-figure-left figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cs11-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Schematization of the Crystal basin 1.1
</figcaption>
</figure>
</div>
<p>After writing model.write a subfolder <code>Crystal_1.1</code> is created, which contains the model input data and configuration:</p>
<ul>
<li>ribasim.toml: The model configuration</li>
<li>database.gpkg: A geopackage containing the shapes of your schematization and the input data of the nodes used.</li>
</ul>
<p>Now run the model:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>subprocess.run([rib_path, toml_path], check<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-9-post-processing-results" class="level3" data-number="3.1.9">
<h3 data-number="3.1.9" class="anchored" data-anchor-id="step-9-post-processing-results"><span class="header-section-number">3.1.9</span> Step 9: Post-processing results</h3>
<p>Read the arrow files and plot the simulated flows from different edges and the levels and storages at our confluence point:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>df_basin <span class="op">=</span> pd.read_feather(model_dir <span class="op">/</span> <span class="st">"Crystal_1.1/results/basin.arrow"</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create pivot tables and plot for basin data</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>df_basin_wide <span class="op">=</span> df_basin.pivot_table(</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>index<span class="op">=</span><span class="st">"time"</span>, columns<span class="op">=</span><span class="st">"node_id"</span>, values<span class="op">=</span>[<span class="st">"storage"</span>, <span class="st">"level"</span>]</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Skip the first timestep as it’s the initialization step</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>df_basin_wide <span class="op">=</span> df_basin_wide.iloc[<span class="dv">1</span>:]</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot level and storage on the same graph with dual y-axes</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot level on the primary y-axis</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>color <span class="op">=</span> <span class="st">'b'</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">'Time'</span>)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">'Level [m]'</span>, color<span class="op">=</span>color)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>ax1.plot(df_basin_wide.index, df_basin_wide[<span class="st">"level"</span>], color<span class="op">=</span>color)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>ax1.tick_params(axis<span class="op">=</span><span class="st">'y'</span>, labelcolor<span class="op">=</span>color)</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a secondary y-axis for storage</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> ax1.twinx()</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>color <span class="op">=</span> <span class="st">'r'</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">'Storage [m³]'</span>, color<span class="op">=</span><span class="st">'r'</span>)</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>ax2.plot(df_basin_wide.index, df_basin_wide[<span class="st">"storage"</span>],linestyle<span class="op">=</span><span class="st">'--'</span>, color<span class="op">=</span>color)</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>ax2.tick_params(axis<span class="op">=</span><span class="st">'y'</span>, labelcolor<span class="op">=</span>color)</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()  <span class="co"># Adjust layout to fit labels</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Basin Level and Storage Over Time'</span>)</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot flow data</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the data from feather format</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>df_flow <span class="op">=</span> pd.read_feather(model_dir <span class="op">/</span> <span class="st">"Crystal_1.1/results/flow.arrow"</span>)</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Create 'edge' and 'flow_m3d' columns</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>df_flow[<span class="st">"edge"</span>] <span class="op">=</span> <span class="bu">list</span>(<span class="bu">zip</span>(df_flow.from_node_id, df_flow.to_node_id))</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a pivot table</span></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>pivot_flow <span class="op">=</span> df_flow.pivot_table(index<span class="op">=</span><span class="st">"time"</span>, columns<span class="op">=</span><span class="st">"edge"</span>, values<span class="op">=</span><span class="st">"flow_rate"</span>)</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Skip the first timestep</span></span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>pivot_flow <span class="op">=</span> pivot_flow.iloc[<span class="dv">1</span>:]</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>line_styles <span class="op">=</span> [<span class="st">'-'</span>, <span class="st">'--'</span>, <span class="st">'-'</span>, <span class="st">'-.'</span>]</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>num_styles <span class="op">=</span> <span class="bu">len</span>(line_styles)</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, column <span class="kw">in</span> <span class="bu">enumerate</span>(pivot_flow.columns):</span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>    pivot_flow[column].plot(ax<span class="op">=</span>ax, linestyle<span class="op">=</span>line_styles[i <span class="op">%</span> num_styles],linewidth<span class="op">=</span><span class="fl">1.5</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Set labels and title</span></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Time'</span>)</span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Flow [m³/s]'</span>)</span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>ax.legend(bbox_to_anchor<span class="op">=</span>(<span class="fl">1.15</span>, <span class="dv">1</span>), title<span class="op">=</span><span class="st">"Edge"</span>)</span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Flow Over Time'</span>)</span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><a href="#fig-sim1" class="quarto-xref">Figure&nbsp;5</a> shows the storage and levels in the basin node.</p>
<p>In this configuration the basin node is designed to ensure that inflow equals outflow, effectively simulating a controlled junction where water flow is managed rather than stored. To accurately represent the relationship between water levels and discharge rates at this confluence, a rating curve node is implemented. This setup mimics the behavior of a gate or spillway, allowing us to model how varying water levels influence flow rates at the confluence. Since the basin node is functioning as a confluence rather than a storage reservoir, the simulated water levels and storage trends will closely follow the inflow patterns. This is because there is no net change in storage; all incoming water is balanced by outgoing flow.</p>
<div id="fig-sim1" class="quarto-float quarto-figure quarto-figure-left anchored" data-fig-align="left">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-sim1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://github.com/user-attachments/assets/1e039b16-1db9-4bb1-bd85-9e3b6692d771.png" class="img-fluid quarto-figure quarto-figure-left figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-sim1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Simulated basin level and storage
</figcaption>
</figure>
</div>
<p><a href="#fig-sim2" class="quarto-xref">Figure&nbsp;6</a> shows the discharges in <span class="math inline">\(\text{m}^3/\text{s}\)</span> on each edge. Edge (3,4) represents the flow from the confluence to the tabulated rating curve and edge (4,5) represents the flow from the tabulated rating curve to the terminal. Both show the same discharge over time. Which is expected in a natural flow environment, as what is coming into the confluence must come out.</p>
<div id="fig-sim2" class="quarto-float quarto-figure quarto-figure-left anchored" data-fig-align="left">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-sim2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://github.com/user-attachments/assets/37c99ecf-dfd1-47e0-8be7-61ec885da232.png" class="img-fluid quarto-figure quarto-figure-left figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-sim2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Simulated flows on each edge
</figcaption>
</figure>
</div>
</section>
</section>
<section id="modual-1.2---irrigation-demand" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="modual-1.2---irrigation-demand"><span class="header-section-number">3.2</span> Modual 1.2 - Irrigation demand</h2>
<p>Let us modify the environment to include agricultural activities within the basin, which necessitate irrigation. In a conventional irrigation setup, some water is diverted from the Main River through a canal, with a portion of it eventually returning to the main river (see <a href="#fig-irrigation" class="quarto-xref">Figure&nbsp;7</a>).</p>
<div id="fig-irrigation" class="quarto-float quarto-figure quarto-figure-left anchored" data-fig-align="left">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-irrigation-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://github.com/user-attachments/assets/64fa750c-d7b9-4f5c-9a24-2f95e2b8bba8.png" class="img-fluid quarto-figure quarto-figure-left figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-irrigation-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Crystal basin with irrigation
</figcaption>
</figure>
</div>
<p>For this update schematization, we need to incorporate three additional nodes:</p>
<ul>
<li>Basin: Represents a cross-sectional point where water is diverted.</li>
<li>User Demand: Represents the irrigation demand.</li>
<li>Tabulates Rating Curve: Defines the remaining water flow from the main river at the diversion point.</li>
</ul>
<section id="step-1-setup-the-model-adjust-import-packages" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="step-1-setup-the-model-adjust-import-packages"><span class="header-section-number">3.2.1</span> Step 1: Setup the model &amp; adjust Import Packages</h3>
<p>Copy and paste the python script <code>Crystal_1.1</code> and rename it <code>Crystal_1.2</code>. De import modules remain the same, except a demand needs to be added and if you want to have a more interactive plot then importing <code>plotly</code> can be useful.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutilfrom</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pathlib</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ribasim <span class="im">import</span> Allocation, Model, Node <span class="co"># The main library used for river basin modeling.</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ribasim.nodes <span class="im">import</span> (</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    flow_boundary,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    basin,</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    tabulated_rating_curve,</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    user_demand,</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    terminal</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.geometry <span class="im">import</span> Point</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess  <span class="co"># For running the model</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-2-add-a-second-basin-node" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="step-2-add-a-second-basin-node"><span class="header-section-number">3.2.2</span> Step 2: Add a second Basin node</h3>
<p>Schematically we are dealing with two basins. To keep the order of flow from upstream to downstream it is recommended to adjust the node_id numbers accordingly. In this case <code>node_id = 3</code> will be <code>node_id = 4</code>. Basin 3 will portray as the point in the river where the diversion takes place, getting the name <code>Div</code>. Its profile area at this intersection is slightly smaller than at the confluence.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>model.basin.add(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    Node(<span class="dv">3</span>, Point(<span class="op">-</span><span class="fl">0.75</span>, <span class="op">-</span><span class="fl">0.5</span>), name<span class="op">=</span><span class="st">'Div'</span>),</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    [basin.Profile(area<span class="op">=</span>[<span class="dv">500000</span>, <span class="dv">5000000</span>], level<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">6</span>]),</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>     basin.State(level<span class="op">=</span>[<span class="dv">3</span>]),</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>     basin.Time(time<span class="op">=</span>[starttime, endtime]),</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>model.basin.add(</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    Node(<span class="dv">4</span>, Point(<span class="op">-</span><span class="fl">1.5</span>, <span class="op">-</span><span class="dv">1</span>), name<span class="op">=</span><span class="st">'Conf'</span>),</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    [basin.Profile(area<span class="op">=</span>[<span class="dv">672000</span>, <span class="dv">5600000</span>], level<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">6</span>]),</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>     basin.State(level<span class="op">=</span>[<span class="dv">4</span>]),</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>     basin.Time(time<span class="op">=</span>[starttime, endtime]),</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-3-add-the-irrigation-demand" class="level3" data-number="3.2.3">
<h3 data-number="3.2.3" class="anchored" data-anchor-id="step-3-add-the-irrigation-demand"><span class="header-section-number">3.2.3</span> Step 3: Add the irrigation demand</h3>
<p>A big farm company needs to apply irrigation to its field starting from April to September. The irrigated field is <span class="math inline">\(&gt; 17000 \text{ ha}\)</span> and requires around <span class="math inline">\(5 \text{ mm/day}\)</span>. In this case the farm company diverts from the main river an average flow rate of <span class="math inline">\(10 \text{ m}^3/\text{s}\)</span> and <span class="math inline">\(12 \text{ m}^3/\text{s}\)</span> during spring and summer, respectively. Start of irrigation takes place on the 1st of April until the end of August. The farmer taps water through a canal (demand).</p>
<p>For now, let’s assume the return flow remains <span class="math inline">\(0.0\)</span> (<code>return_factor</code>). Meaning all the supplied water to fulfill the demand is consumed and does not return back to the river. The user demand node interpolates the demand values. Thus the following code needs to be implemented:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>model.user_demand.add(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    Node(<span class="dv">6</span>, Point(<span class="op">-</span><span class="fl">1.5</span>, <span class="fl">1.0</span>), name<span class="op">=</span><span class="st">'IrrA'</span>),</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    [user_demand.Time(</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>        demand<span class="op">=</span>[<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="dv">10</span>, <span class="dv">12</span>, <span class="dv">12</span>, <span class="fl">0.0</span>],</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>        return_factor<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>        min_level<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>        priority<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>        time<span class="op">=</span>[starttime, <span class="st">"2022-03-31"</span>, <span class="st">"2022-04-01"</span>, <span class="st">"2022-07-01"</span>, <span class="st">"2022-09-30"</span>, <span class="st">"2022-10-01"</span>]</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-4-add-a-tabulated-rating-curve" class="level3" data-number="3.2.4">
<h3 data-number="3.2.4" class="anchored" data-anchor-id="step-4-add-a-tabulated-rating-curve"><span class="header-section-number">3.2.4</span> Step 4: Add a tabulated rating curve</h3>
<p>The second Tabulated Rating Curve node will simulate the rest of the water that is left after diverting a part from the main river to the farm field. The rest of the water will flow naturally towards the confluence:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>model.tabulated_rating_curve.add(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    Node(<span class="dv">7</span>, Point(<span class="op">-</span><span class="fl">1.125</span>, <span class="op">-</span><span class="fl">0.75</span>), name<span class="op">=</span><span class="st">'MainDiv'</span>),</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    [tabulated_rating_curve.Static(</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>        level<span class="op">=</span>[<span class="fl">0.0</span>, <span class="fl">1.5</span>, <span class="dv">5</span>],</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>        flow_rate<span class="op">=</span>[<span class="fl">0.0</span>, <span class="dv">45</span>, <span class="dv">200</span>],</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>It is up to the user to renumber the ID’s of the nodes. Applying the ID number based on the order of the nodes from up- to downstream keeps it more organized, but not necessary.</p>
</section>
<section id="step-5-adjust-the-terminal-node-id-and-edges" class="level3" data-number="3.2.5">
<h3 data-number="3.2.5" class="anchored" data-anchor-id="step-5-adjust-the-terminal-node-id-and-edges"><span class="header-section-number">3.2.5</span> Step 5: Adjust the terminal node id and edges</h3>
<p>Adjust the terminal node id. Since we added more nodes we have more edges. Add and adjust the edges:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>model.terminal.add(Node(<span class="dv">8</span>, Point(<span class="op">-</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">3.0</span>), name<span class="op">=</span><span class="st">"Terminal"</span>))</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>model.edge.add(model.flow_boundary[<span class="dv">1</span>], model.basin[<span class="dv">3</span>])</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>model.edge.add(model.flow_boundary[<span class="dv">2</span>], model.basin[<span class="dv">4</span>])</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>model.edge.add(model.basin[<span class="dv">3</span>], model.user_demand[<span class="dv">6</span>])</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>model.edge.add(model.user_demand[<span class="dv">6</span>], model.basin[<span class="dv">4</span>])</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>model.edge.add(model.basin[<span class="dv">3</span>], model.tabulated_rating_curve[<span class="dv">7</span>])</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>model.edge.add(model.tabulated_rating_curve[<span class="dv">7</span>], model.basin[<span class="dv">4</span>])</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>model.edge.add(model.basin[<span class="dv">4</span>], model.tabulated_rating_curve[<span class="dv">5</span>])</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>model.edge.add(model.tabulated_rating_curve[<span class="dv">5</span>], model.terminal[<span class="dv">8</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-6-plot-model-and-run" class="level3" data-number="3.2.6">
<h3 data-number="3.2.6" class="anchored" data-anchor-id="step-6-plot-model-and-run"><span class="header-section-number">3.2.6</span> Step 6: Plot model and run</h3>
<p>Plot the schematization and run the model. This time the new outputs should be written in a new folder called <code>Crystal_1.2</code>:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>model.plot()</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>toml_path <span class="op">=</span> model_dir<span class="op">/</span> <span class="st">"Crystal_1.2/ribasim.toml"</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>model.write(toml_path)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>rib_path <span class="op">=</span> base_dir <span class="op">/</span> <span class="st">"ribasim_windows/ribasim.exe"</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>subprocess.run([rib_path, toml_path], check<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The schematization should look like <a href="#fig-cs12" class="quarto-xref">Figure&nbsp;8</a>.</p>
<div id="fig-cs12" class="quarto-float quarto-figure quarto-figure-left anchored" data-fig-align="left">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cs12-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://github.com/user-attachments/assets/6241d388-5373-4f6c-b1f6-ff1a1a34d0e6.png" class="img-fluid quarto-figure quarto-figure-left figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cs12-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: Schematization of the Crystal basin with irrigation
</figcaption>
</figure>
</div>
</section>
<section id="step-7-name-the-edges-and-basins" class="level3" data-number="3.2.7">
<h3 data-number="3.2.7" class="anchored" data-anchor-id="step-7-name-the-edges-and-basins"><span class="header-section-number">3.2.7</span> Step 7: Name the edges and basins</h3>
<p>The names of each nodes are defined and saved in the geopackage. However, in the dataframe this needs to be added by creating a dictionary and map it within the dataframe.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Dictionary mapping node_ids to names</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>edge_names <span class="op">=</span> {</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span>,<span class="dv">3</span>): <span class="st">'Main'</span>,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span>,<span class="dv">4</span>): <span class="st">'Minor'</span>,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">3</span>,<span class="dv">6</span>): <span class="st">'IrrA Demand'</span>,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">6</span>,<span class="dv">4</span>): <span class="st">'IrrA Drain'</span>,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">3</span>,<span class="dv">7</span>): <span class="st">'Div2Main'</span>,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">7</span>,<span class="dv">4</span>): <span class="st">'Main2Conf'</span>,</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">4</span>,<span class="dv">5</span>): <span class="st">'Conf2TRC'</span>,</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">5</span>,<span class="dv">8</span>): <span class="st">'TRC2Term'</span>,</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Dictionary mapping basins (node_ids) to names</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>node_names <span class="op">=</span> {</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    <span class="dv">3</span>: <span class="st">'Div'</span>,</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    <span class="dv">4</span>: <span class="st">'Conf'</span>,</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-8-plot-and-compare-the-basin-results" class="level3" data-number="3.2.8">
<h3 data-number="3.2.8" class="anchored" data-anchor-id="step-8-plot-and-compare-the-basin-results"><span class="header-section-number">3.2.8</span> Step 8: Plot and compare the basin results</h3>
<p>Plot the simulated levels and storages at the diverted section (basin 3) and at the confluence (basin 4).</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>df_basin_div <span class="op">=</span> df_basin_wide.xs(<span class="st">'Div'</span>, axis<span class="op">=</span><span class="dv">1</span>, level<span class="op">=</span><span class="dv">1</span>, drop_level<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>df_basin_conf <span class="op">=</span> df_basin_wide.xs(<span class="st">'Conf'</span>, axis<span class="op">=</span><span class="dv">1</span>, level<span class="op">=</span><span class="dv">1</span>, drop_level<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_basin_data(ax, ax_twin, df_basin, level_color<span class="op">=</span><span class="st">'b'</span>, storage_color<span class="op">=</span><span class="st">'r'</span>, title<span class="op">=</span><span class="st">'Basin'</span>):</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot level data</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, column <span class="kw">in</span> <span class="bu">enumerate</span>(df_basin[<span class="st">"level"</span>].columns):</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>        ax.plot(df_basin.index, df_basin[<span class="st">"level"</span>][column],</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>                linestyle<span class="op">=</span><span class="st">'-'</span>, color<span class="op">=</span>level_color,</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="ss">f'Level - </span><span class="sc">{</span>column<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot storage data</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, column <span class="kw">in</span> <span class="bu">enumerate</span>(df_basin[<span class="st">"storage"</span>].columns):</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>        ax_twin.plot(df_basin.index, df_basin[<span class="st">"storage"</span>][column],</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>                     linestyle<span class="op">=</span><span class="st">'--'</span>, color<span class="op">=</span>storage_color,</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>                     label<span class="op">=</span><span class="ss">f'Storage - </span><span class="sc">{</span>column<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Level [m]'</span>, color<span class="op">=</span>level_color)</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    ax_twin.set_ylabel(<span class="st">'Storage [m³]'</span>, color<span class="op">=</span>storage_color)</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">'y'</span>, labelcolor<span class="op">=</span>level_color)</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    ax_twin.tick_params(axis<span class="op">=</span><span class="st">'y'</span>, labelcolor<span class="op">=</span>storage_color)</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>    ax.set_title(title)</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine legends from both axes</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>    lines, labels <span class="op">=</span> ax.get_legend_handles_labels()</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    lines_twin, labels_twin <span class="op">=</span> ax_twin.get_legend_handles_labels()</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    ax.legend(lines <span class="op">+</span> lines_twin, labels <span class="op">+</span> labels_twin, loc<span class="op">=</span><span class="st">'upper left'</span>)</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Create subplots</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>fig, (ax1, ax3) <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">12</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot Div basin data</span></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> ax1.twinx()  <span class="co"># Secondary y-axis for storage</span></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>plot_basin_data(ax1, ax2, df_basin_div, title<span class="op">=</span><span class="st">'Div Basin Level and Storage over Time'</span>)</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot Conf basin data</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>ax4 <span class="op">=</span> ax3.twinx()  <span class="co"># Secondary y-axis for storage</span></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>plot_basin_data(ax3, ax4, df_basin_conf, title<span class="op">=</span><span class="st">'Conf Basin Level and Storage over Time'</span>)</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Common X label</span></span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>ax3.set_xlabel(<span class="st">'Time'</span>)</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()  <span class="co"># Adjust layout to fit labels</span></span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><a href="#fig-sim3" class="quarto-xref">Figure&nbsp;9</a> illustrates the water levels and storage capacities for each basin. At the diverted section, where the profile is narrower than at the confluence, we anticipate lower storage and water levels compared to the confluence section.</p>
<p>When compared to the natural flow conditions, where no water is abstracted for irrigation (See Crystal 1.1), there is a noticeable decrease in both storage and water levels at the confluence downstream. This reduction is attributed to the irrigation demand upstream with no return flow, which decreases the amount of available water in the main river, resulting in lower water levels at the confluence.</p>
<div id="fig-sim3" class="quarto-float quarto-figure quarto-figure-left anchored" data-fig-align="left">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-sim3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://github.com/user-attachments/assets/cce87cfb-9a7b-4025-812a-e2c35fa932a9.png" class="img-fluid quarto-figure quarto-figure-left figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-sim3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9: Simulated basin levels and storages
</figcaption>
</figure>
</div>
</section>
<section id="step-9-plot-and-compare-the-flow-results" class="level3" data-number="3.2.9">
<h3 data-number="3.2.9" class="anchored" data-anchor-id="step-9-plot-and-compare-the-flow-results"><span class="header-section-number">3.2.9</span> Step 9: Plot and compare the flow results</h3>
<p>Plot the flow results in an interactive plotting tool.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>df_flow <span class="op">=</span> pd.read_feather(model_dir <span class="op">/</span> <span class="st">"Crystal_1.2/results/flow.arrow"</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>df_flow[<span class="st">"edge"</span>] <span class="op">=</span> <span class="bu">list</span>(<span class="bu">zip</span>(df_flow.from_node_id, df_flow.to_node_id))</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>df_flow[<span class="st">"name"</span>] <span class="op">=</span> df_flow[<span class="st">"edge"</span>].<span class="bu">map</span>(edge_names)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the flow data, interactive plot with Plotly</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>pivot_flow <span class="op">=</span> df_flow.pivot_table(index<span class="op">=</span><span class="st">"time"</span>, columns<span class="op">=</span><span class="st">"name"</span>, values<span class="op">=</span><span class="st">"flow_rate"</span>).reset_index()</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> px.line(pivot_flow, x<span class="op">=</span><span class="st">"time"</span>, y<span class="op">=</span>pivot_flow.columns[<span class="dv">1</span>:], title<span class="op">=</span><span class="st">"Flow Over Time [m3/s]"</span>)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>fig.update_layout(legend_title_text<span class="op">=</span><span class="st">'Edge'</span>)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>fig.write_html(model_dir<span class="op">/</span> <span class="st">"Crystal_1.2/plot_edges.html"</span>)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The plot will be saved as an HTML file, which can be viewed by dragging the file into an internet browser (<a href="#fig-sim4" class="quarto-xref">Figure&nbsp;10</a>).</p>
<div id="fig-sim4" class="quarto-float quarto-figure quarto-figure-left anchored" data-fig-align="left">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-sim4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://github.com/user-attachments/assets/2a27ab07-a4c5-4906-bdcd-45491f868042.png" class="img-fluid quarto-figure quarto-figure-left figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-sim4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;10: Simulated flows of each edge
</figcaption>
</figure>
</div>
<p>When selecting only the flow demanded by the User Demand node, or in other words the supply for irrigation increases at times when it is required (<a href="#fig-sim5" class="quarto-xref">Figure&nbsp;11</a>) and the return flow remains zero, as the assumption defined before was that there is no drain.</p>
<div id="fig-sim5" class="quarto-float quarto-figure quarto-figure-left anchored" data-fig-align="left">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-sim5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://github.com/user-attachments/assets/e87f75d3-c721-41f5-92c3-768a42ffd92e.png" class="img-fluid quarto-figure quarto-figure-left figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-sim5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11: Supplied irrigation and return flow
</figcaption>
</figure>
</div>
<p><a href="#fig-sim6" class="quarto-xref">Figure&nbsp;12</a> shows the flow to the ocean (Terminal). Compared to Crystal 1.1 the flow has decreased during the irrigated period. Indicating the impact of irrigation without any drain.</p>
<div id="fig-sim6" class="quarto-float quarto-figure quarto-figure-left anchored" data-fig-align="left">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-sim6-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://github.com/user-attachments/assets/b4563cbd-4919-4422-9cb8-70deebf98094.png" class="img-fluid quarto-figure quarto-figure-left figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-sim6-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12: Simulated flow to Terminal
</figcaption>
</figure>
</div>
</section>
</section>
</section>
<section id="modual-2-reservoirs-and-public-water-supply" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Modual 2 – Reservoirs and Public Water Supply</h1>
<p>Due to the increase of population and climate change Crystal city has implemented a reservoir upstream to store water for domestic use (See <a href="#fig-reservoir" class="quarto-xref">Figure&nbsp;13</a>). The reservoir is to help ensure a reliable supply during dry periods. In this module, the user will update the model to incorporate the reservoir’s impact on the whole Crystal Basin.</p>
<div id="fig-reservoir" class="quarto-float quarto-figure quarto-figure-left anchored" data-fig-align="left">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-reservoir-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://github.com/user-attachments/assets/615f6d93-bdb9-4a38-a308-c5c0929930b5.png" class="img-fluid quarto-figure quarto-figure-left figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-reservoir-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13: Crystal basin with demands and a reservoir
</figcaption>
</figure>
</div>
<section id="modual-2.1-reservoir" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="modual-2.1-reservoir"><span class="header-section-number">4.1</span> Modual 2.1 – Reservoir</h2>
<section id="step-1-add-a-basin" class="level3" data-number="4.1.1">
<h3 data-number="4.1.1" class="anchored" data-anchor-id="step-1-add-a-basin"><span class="header-section-number">4.1.1</span> Step 1: Add a basin</h3>
<p>This time the basin 3 will function as a reservoir instead of a diversion, meaning it’s storage and levels will play an important role for the users (the city and the farmer). The reservoir has a max. area of <span class="math inline">\(32.3 \text{ km}^2\)</span> and a max. depth of <span class="math inline">\(7 \text{ m}\)</span>. The profile of basin 3 should change to:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>model.basin.add(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    Node(<span class="dv">3</span>, Point(<span class="op">-</span><span class="fl">0.75</span>, <span class="op">-</span><span class="fl">0.5</span>), name<span class="op">=</span><span class="st">'Rsv'</span>),</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    [basin.Profile(area<span class="op">=</span>[<span class="dv">20000000</span>, <span class="dv">32300000</span>], level<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">7</span>]),</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>     basin.State(level<span class="op">=</span>[<span class="fl">3.5</span>]),</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>     basin.Time(time<span class="op">=</span>[starttime, endtime]),</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-2-adjust-the-code" class="level3" data-number="4.1.2">
<h3 data-number="4.1.2" class="anchored" data-anchor-id="step-2-adjust-the-code"><span class="header-section-number">4.1.2</span> Step 2: Adjust the code</h3>
<p>Adjust the naming of the basin in the dictionary mapping and the saving file should be <code>Crystal_2.1</code> instead of <code>*_1.2</code>.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>toml_path <span class="op">=</span> model_dir<span class="op">/</span> <span class="st">"Crystal_2.1/ribasim.toml"</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>model.write(toml_path)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>rib_path <span class="op">=</span> base_dir <span class="op">/</span> <span class="st">"ribasim_windows/ribasim.exe"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Dictionary mapping node_ids to names</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>edge_names <span class="op">=</span> {</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span>,<span class="dv">3</span>): <span class="st">'Main'</span>,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span>,<span class="dv">4</span>): <span class="st">'Minor'</span>,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">3</span>,<span class="dv">6</span>): <span class="st">'IrrA Demand'</span>,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">6</span>,<span class="dv">4</span>): <span class="st">'IrrA Drain'</span>,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">3</span>,<span class="dv">7</span>): <span class="st">'Rsv2Main'</span>,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">7</span>,<span class="dv">4</span>): <span class="st">'Main2Conf'</span>,</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">4</span>,<span class="dv">5</span>): <span class="st">'Conf2TRC'</span>,</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">5</span>,<span class="dv">8</span>): <span class="st">'TRC2Term'</span>,</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Dictionary mapping basins (node_ids) to names</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>node_names <span class="op">=</span> {</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    <span class="dv">3</span>: <span class="st">'Rsv'</span>,</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="dv">4</span>: <span class="st">'Conf'</span>,</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>df_basin <span class="op">=</span> pd.read_feather(model_dir <span class="op">/</span> <span class="st">"Crystal_2.1/results/basin.arrow"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create pivot tables and plot for basin data</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>df_basin_rsv <span class="op">=</span> df_basin_wide.xs(<span class="st">'Rsv'</span>, axis<span class="op">=</span><span class="dv">1</span>, level<span class="op">=</span><span class="dv">1</span>, drop_level<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>df_basin_conf <span class="op">=</span> df_basin_wide.xs(<span class="st">'Conf'</span>, axis<span class="op">=</span><span class="dv">1</span>, level<span class="op">=</span><span class="dv">1</span>, drop_level<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot Rsv basin data</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> ax1.twinx()  <span class="co"># Secondary y-axis for storage</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>plot_basin_data(ax1, ax2, df_basin_rsv, title<span class="op">=</span><span class="st">'Reservoir Level and Storage Over Time'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample data loading and preparation</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>df_flow <span class="op">=</span> pd.read_feather(model_dir <span class="op">/</span> <span class="st">"Crystal_2.1/results/flow.arrow"</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>df_flow[<span class="st">"edge"</span>] <span class="op">=</span> <span class="bu">list</span>(<span class="bu">zip</span>(df_flow.from_node_id, df_flow.to_node_id))</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>df_flow[<span class="st">"name"</span>] <span class="op">=</span> df_flow[<span class="st">"edge"</span>].<span class="bu">map</span>(edge_names)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the flow data, interactive plot with Plotly</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>pivot_flow <span class="op">=</span> df_flow.pivot_table(index<span class="op">=</span><span class="st">"time"</span>, columns<span class="op">=</span><span class="st">"name"</span>, values<span class="op">=</span><span class="st">"flow_rate"</span>).reset_index()</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> px.line(pivot_flow, x<span class="op">=</span><span class="st">"time"</span>, y<span class="op">=</span>pivot_flow.columns[<span class="dv">1</span>:], title<span class="op">=</span><span class="st">"Flow Over Time [m3/s]"</span>)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>fig.update_layout(legend_title_text<span class="op">=</span><span class="st">'Edge'</span>)</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>fig.write_html(model_dir<span class="op">/</span> <span class="st">"Crystal_2.1/plot_edges.html"</span>)</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-3-plotting-results" class="level3" data-number="4.1.3">
<h3 data-number="4.1.3" class="anchored" data-anchor-id="step-3-plotting-results"><span class="header-section-number">4.1.3</span> Step 3: Plotting results</h3>
<p><a href="#fig-sim7" class="quarto-xref">Figure&nbsp;14</a> illustrates the new storage and water level at the reservoir. As expected, after increasing the profile of basin 3 to mimic the reservoir, its storage capacity increased as well.</p>
<div id="fig-sim7" class="quarto-float quarto-figure quarto-figure-left anchored" data-fig-align="left">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-sim7-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://github.com/user-attachments/assets/545b6ce0-1a87-4f3b-b87e-79d7382beac2.png" class="img-fluid quarto-figure quarto-figure-left figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-sim7-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;14: Simulated basin storages and levels
</figcaption>
</figure>
</div>
</section>
</section>
<section id="module-2.2-public-water-supply" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="module-2.2-public-water-supply"><span class="header-section-number">4.2</span> Module 2.2 – Public Water Supply</h2>
<section id="step-1-rename-the-saving-files" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="step-1-rename-the-saving-files"><span class="header-section-number">4.2.1</span> Step 1: Rename the saving files</h3>
<p>Rename the files to <code>Crystal_2.2</code></p>
</section>
<section id="step-2-add-a-demand-node" class="level3" data-number="4.2.2">
<h3 data-number="4.2.2" class="anchored" data-anchor-id="step-2-add-a-demand-node"><span class="header-section-number">4.2.2</span> Step 2: Add a demand node</h3>
<p><span class="math inline">\(50.000\)</span> people live in Crystal City. To represents the total flow rate or abstraction rate required to meet the water demand of <span class="math inline">\(50,000\)</span> people, another demand node needs to be added assuming a return flow of <span class="math inline">\(60%\)</span>.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>model.user_demand.add(</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    Node(<span class="dv">9</span>, Point(<span class="fl">0.0</span>, <span class="op">-</span><span class="fl">0.25</span>), name<span class="op">=</span><span class="st">'PWS'</span>),</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    [user_demand.Time(</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>        demand<span class="op">=</span>[<span class="fl">0.07</span>, <span class="fl">0.08</span>, <span class="fl">0.09</span>, <span class="fl">0.10</span>, <span class="fl">0.12</span>, <span class="fl">0.14</span>, <span class="fl">0.15</span>, <span class="fl">0.14</span>, <span class="fl">0.12</span>, <span class="fl">0.10</span>, <span class="fl">0.09</span>, <span class="fl">0.08</span>],  <span class="co"># Total demand in m³/s</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>        return_factor<span class="op">=</span><span class="fl">0.6</span>,</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>        min_level<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>        priority<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>        time<span class="op">=</span>[</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>            starttime,</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">"2022-02-01"</span>,</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">"2022-03-01"</span>,</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">"2022-04-01"</span>,</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">"2022-05-01"</span>,</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">"2022-06-01"</span>,</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">"2022-07-01"</span>,</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">"2022-08-01"</span>,</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">"2022-09-01"</span>,</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">"2022-10-01"</span>,</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"2022-11-01"</span>,</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">"2022-12-01"</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>    )]</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-3-add-the-edges" class="level3" data-number="4.2.3">
<h3 data-number="4.2.3" class="anchored" data-anchor-id="step-3-add-the-edges"><span class="header-section-number">4.2.3</span> Step 3: Add the edges</h3>
<p>The connection between the reservoir and the demand node needs to be defined:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>model.edge.add(model.flow_boundary[<span class="dv">1</span>], model.basin[<span class="dv">3</span>])</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>model.edge.add(model.flow_boundary[<span class="dv">2</span>], model.basin[<span class="dv">4</span>])</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>model.edge.add(model.basin[<span class="dv">3</span>], model.user_demand[<span class="dv">6</span>])</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>model.edge.add(model.basin[<span class="dv">3</span>], model.user_demand[<span class="dv">9</span>])</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>model.edge.add(model.user_demand[<span class="dv">6</span>], model.basin[<span class="dv">4</span>])</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>model.edge.add(model.user_demand[<span class="dv">9</span>], model.basin[<span class="dv">4</span>])</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>model.edge.add(model.basin[<span class="dv">3</span>], model.tabulated_rating_curve[<span class="dv">7</span>])</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>model.edge.add(model.tabulated_rating_curve[<span class="dv">7</span>], model.basin[<span class="dv">4</span>])</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>model.edge.add(model.basin[<span class="dv">4</span>], model.tabulated_rating_curve[<span class="dv">5</span>])</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>model.edge.add(model.tabulated_rating_curve[<span class="dv">5</span>], model.terminal[<span class="dv">8</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-4-adjust-the-name-dictionaries" class="level3" data-number="4.2.4">
<h3 data-number="4.2.4" class="anchored" data-anchor-id="step-4-adjust-the-name-dictionaries"><span class="header-section-number">4.2.4</span> Step 4: Adjust the name dictionaries</h3>
<div class="sourceCode" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Dictionary mapping node_ids to names</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>edge_names <span class="op">=</span> {</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span>,<span class="dv">3</span>): <span class="st">'Main'</span>,</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span>,<span class="dv">4</span>): <span class="st">'Minor'</span>,</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">3</span>,<span class="dv">6</span>): <span class="st">'IrrA Demand'</span>,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">6</span>,<span class="dv">4</span>): <span class="st">'IrrA Drain'</span>,</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">3</span>,<span class="dv">9</span>): <span class="st">'PWS Demand'</span>,</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">9</span>,<span class="dv">4</span>): <span class="st">'PWS Return'</span>,</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">3</span>,<span class="dv">7</span>): <span class="st">'Rsv2Main'</span>,</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">7</span>,<span class="dv">4</span>): <span class="st">'Main2Conf'</span>,</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">4</span>,<span class="dv">5</span>): <span class="st">'Conf2TRC'</span>,</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">5</span>,<span class="dv">8</span>): <span class="st">'TRC2Term'</span>,</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-5-check-the-simulated-demands" class="level3" data-number="4.2.5">
<h3 data-number="4.2.5" class="anchored" data-anchor-id="step-5-check-the-simulated-demands"><span class="header-section-number">4.2.5</span> Step 5: Check the simulated demands</h3>
<p><a href="#fig-sim8" class="quarto-xref">Figure&nbsp;15</a> shows the flow to (PWS Demand) and out (PWS Return) of the PWS node. <a href="#fig-sim9" class="quarto-xref">Figure&nbsp;16</a> shows the downstream flow to the ocean. The impact is clear. Due to the demands upstream (irrigation and public water supply) an expected decrease of discharge is shown downstream.</p>
<div id="fig-sim8" class="quarto-float quarto-figure quarto-figure-left anchored" data-fig-align="left">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-sim8-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://github.com/user-attachments/assets/937a4868-87d1-4b5f-b37d-ab865428740d.png" class="img-fluid quarto-figure quarto-figure-left figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-sim8-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15: Simulated flows to and from the city
</figcaption>
</figure>
</div>
<div id="fig-sim9" class="quarto-float quarto-figure quarto-figure-left anchored" data-fig-align="left">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-sim9-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://github.com/user-attachments/assets/16fce006-5e8b-4657-9b80-f26d1489ca99.png" class="img-fluid quarto-figure quarto-figure-left figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-sim9-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;16: Simulated basin storages and levels
</figcaption>
</figure>
</div>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
  </div>
  <div class="nav-page nav-page-next">
      <a href="../guide/examples.html" class="pagination-link" aria-label="Examples">
        <span class="nav-page-text">Examples</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>